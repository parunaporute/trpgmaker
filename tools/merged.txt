è²´æ–¹ã¯ä¼šç¤¾ã®ä¸­ã§ä¸€ç•ªã®ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã§ã™ã€E
ãƒ»
ãƒ»
ãƒ»
ãƒ»
ãƒ»
ECHO ‚Í <OFF> ‚Å‚·B
ä»¥ä¸Šã‚’å®Ÿæ–½ã—ã€ç·¨é›E—ãªãEƒ•ã‚¡ã‚¤ãƒ«ã‚’é™¤ãå®ŒåEãªã‚³ãƒ¼ãƒ‰ã‚’ä¸‹ã•ãE€E
characterCreate.html 
<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>ã‚¨ãƒ¬ãƒ¡ãƒ³ãƒˆä½œæˆ</title>
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <link rel="stylesheet" href="styles.css" />
  <script src="https://cdn.jsdelivr.net/npm/dompurify@2/dist/purify.min.js"></script>
</head>
<body>
    <button id="back-to-menu" style="margin-top:20px;">ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«æˆ»ã‚‹</button>
    <div class="container" style="max-width:800px;">
      <h1>ã‚¨ãƒ¬ãƒ¡ãƒ³ãƒˆä½œæˆ</h1>
      <button id="gacha-btn" style="margin:10px;">ã‚¨ãƒ¬ãƒ¡ãƒ³ãƒˆã‚¬ãƒãƒ£</button>
      <button id="move-gacha-to-warehouse-btn" style="margin:10px;">ã‚¬ãƒãƒ£ç®±ã®ã‚«ãƒ¼ãƒ‰ã‚’å€‰åº«ã«å…¥ã‚Œã‚‹</button>
      <button id="toggle-selection-mode-btn" style="margin:10px;">é¸æŠãƒ¢ãƒ¼ãƒ‰</button>
      <button id="move-selected-to-warehouse-btn" style="display:none; margin:10px;">é¸æŠã—ãŸã‚‚ã®ã‚’å€‰åº«ã«é€ã‚‹</button>

      <div id="gacha-confirm-modal" class="modal" style="display:none;">
        <div class="modal-content">
          <p>ç¾åœ¨ã‚¬ãƒãƒ£ç®±ã«å…¥ã£ã¦ã„ã‚‹ã‚«ãƒ¼ãƒ‰ã¯å‰Šé™¤ã•ã‚Œã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ</p>
          <button id="gacha-confirm-ok">OK</button>
          <button id="gacha-confirm-cancel">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        </div>
      </div>

      <div id="gacha-modal" class="modal" style="display:none;">
        <div class="modal-content">
          <p>ç”Ÿæˆä¸­...</p>
          <button id="cancel-gacha-btn">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        </div>
      </div>

      <div id="card-container"></div>
    </div>

    <!-- IndexedDBãªã©ã®å…±é€šã‚¹ã‚¯ãƒªãƒ—ãƒˆ -->
    <script src="js/indexedDB.js"></script>

    <!-- â˜… ã“ã“ã§å…ˆã«gachaCore.jsã‚’èª­ã¿è¾¼ã‚€ -->
    <script src="js/gachaCore.js"></script>

    <!-- ãã®å¾Œã€characterCreate.jsã‚’èª­ã¿è¾¼ã‚€ -->
    <script src="js/characterCreate.js"></script>

    <script>
      // ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«æˆ»ã‚‹ãƒœã‚¿ãƒ³
      document.getElementById("back-to-menu").addEventListener("click", function () {
        window.location.href = "index.html";
      });
    </script>
</body>
</html>
--- 
index.html 
<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8" />
  <title>TRPG ãƒ¡ãƒ‹ãƒ¥ãƒ¼</title>
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <link rel="stylesheet" href="styles.css" />

  <!-- è¿½åŠ ï¼šã‚«ãƒ¼ãƒ‰è¡¨ç¤ºãªã©ã§DOMPurifyã‚’ä½¿ç”¨ã™ã‚‹ãŸã‚ -->
  <script src="https://cdn.jsdelivr.net/npm/dompurify@2/dist/purify.min.js"></script>
</head>

<body>
  <div class="container" style="text-align:center; margin-top:50px;">
    <h1>TRPG ãƒ¡ãƒ‹ãƒ¥ãƒ¼</h1>
    <div class="api-key-section">
      <label for="api-key-input">ChatGPT APIã‚­ãƒ¼ã‚’å…¥åŠ›ï¼š</label>
      <input type="text" id="api-key-input" placeholder="APIã‚­ãƒ¼ã‚’å…¥åŠ›" />
      <button id="set-api-key-button">APIã‚­ãƒ¼è¨­å®š</button>
      <button id="clear-api-key-button" style="background-color:#f44336;">APIã‚­ãƒ¼ã‚’ã‚¯ãƒªã‚¢</button>
    </div>

    <div class="element-section">
      <!-- ã‚¨ãƒ¬ãƒ¡ãƒ³ãƒˆä½œæˆãƒœã‚¿ãƒ³ -->
      <button id="character-create">ã‚¨ãƒ¬ãƒ¡ãƒ³ãƒˆä½œæˆ</button>
      <!-- ãƒ‘ãƒ¼ãƒ†ã‚£ä½œæˆãƒœã‚¿ãƒ³ -->
      <button id="party-create">ãƒ‘ãƒ¼ãƒ†ã‚£ä½œæˆ</button>
      <!-- å…¨ã‚¨ãƒ¬ãƒ¡ãƒ³ãƒˆã‚¯ãƒªã‚¢ãƒœã‚¿ãƒ³ -->
      <button id="clear-character-btn" style="background-color:#f44336;">å…¨ã‚¨ãƒ¬ãƒ¡ãƒ³ãƒˆã‚’ã‚¯ãƒªã‚¢</button>
      <!-- â˜… è¿½åŠ ï¼šå€‰åº«ç¢ºèªãƒœã‚¿ãƒ³ -->
      <button id="show-warehouse-btn" style="margin-left:10px;">å€‰åº«ç¢ºèª</button>
    </div>

    <!-- æ–°ã—ã„ã‚·ãƒŠãƒªã‚ªã‚’å§‹ã‚ã‚‹ãƒœã‚¿ãƒ³ -->
    <div class="scenario-wizard-section" style="margin-top:20px;">
      <button id="start-new-scenario-button" style="background-color:#2196F3;">
        æ–°ã—ã„ã‚·ãƒŠãƒªã‚ªã‚’å§‹ã‚ã‚‹
      </button>
    </div>

    <!-- é€²è¡Œä¸­ã®ã‚·ãƒŠãƒªã‚ªä¸€è¦§ -->
    <div id="ongoing-scenarios" style="margin-top:30px;">
      <h2>é€²è¡Œä¸­ã®ã‚·ãƒŠãƒªã‚ª</h2>
      <div id="active-scenarios-container">
        <!-- é€²è¡Œä¸­ã‚·ãƒŠãƒªã‚ªã®ãƒªãƒ³ã‚¯ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ï¼ˆç¾åœ¨æœªä½¿ç”¨ï¼‰ -->
      </div>
      <div id="scenario-list-container">
        <!-- JavaScriptã§ä¸€è¦§è¡¨ç¤º & å‰Šé™¤ãƒœã‚¿ãƒ³ã‚’ä»˜ä¸ -->
      </div>
    </div>
  </div>

  <!-- â–¼ ã‚·ãƒŠãƒªã‚ªå‰Šé™¤ç”¨ã®ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="delete-scenario-modal" class="modal" style="display:none;">
    <div class="modal-content">
      <h3>ã‚·ãƒŠãƒªã‚ªå‰Šé™¤ã®ç¢ºèª</h3>
      <p>ã“ã®ã‚·ãƒŠãƒªã‚ªã‚’å‰Šé™¤ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ</p>
      <button id="delete-scenario-ok">OK</button>
      <button id="delete-scenario-cancel">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
    </div>
  </div>

  <!-- â˜… å€‰åº«ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆæ–°è¦è¿½åŠ ï¼‰ -->
  <div id="warehouse-modal" class="modal" style="display:none;">
    <div class="modal-content">
      <h2>å€‰åº«</h2>
      <!-- å€‰åº«å´ã®é¸æŠãƒ¢ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³ -->
      <button id="toggle-warehouse-selection-mode-btn">é¸æŠãƒ¢ãƒ¼ãƒ‰</button>
      <!-- å€‰åº«é¸æŠã‚«ãƒ¼ãƒ‰ã‚’å‰Šé™¤ã™ã‚‹ãƒœã‚¿ãƒ³ -->
      <button id="delete-selected-warehouse-btn" style="display:none; margin:10px;">é¸æŠã—ãŸã‚«ãƒ¼ãƒ‰ã‚’å‰Šé™¤</button>
      <button id="close-warehouse-btn" style="margin:10px;">é–‰ã˜ã‚‹</button>

      <div id="warehouse-card-container" style="margin:10px 0;"></div>
    </div>
  </div>

  <!-- å¤–éƒ¨JavaScript -->
  <script src="js/indexedDB.js"></script>
  <script>
    // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿å®Œäº†å¾Œã«DBåˆæœŸåŒ– -> menu.js ã‚’å‹•çš„ã«èª­ã¿è¾¼ã‚€
    window.addEventListener("load", async () => {
      await initIndexedDB();

      const scriptEl = document.createElement("script");
      scriptEl.src = "js/menu.js";
      document.head.appendChild(scriptEl);
    });
  </script>

  <script>
    // ã‚¨ãƒ¬ãƒ¡ãƒ³ãƒˆä½œæˆãƒœã‚¿ãƒ³æŠ¼ä¸‹æ™‚
    document.getElementById("character-create").addEventListener("click", function () {
      window.location.href = "characterCreate.html";
    });
    // ãƒ‘ãƒ¼ãƒ†ã‚£ä½œæˆãƒœã‚¿ãƒ³æŠ¼ä¸‹æ™‚
    document.getElementById("party-create").addEventListener("click", function () {
      window.location.href = "partyCreate.html";
    });
    // æ–°ã—ã„ã‚·ãƒŠãƒªã‚ªã‚’å§‹ã‚ã‚‹ãƒœã‚¿ãƒ³æŠ¼ä¸‹æ™‚
    document.getElementById("start-new-scenario-button").addEventListener("click", function () {
      window.location.href = "scenarioWizard.html";
    });
  </script>

  <!-- ã‚µãƒ³ãƒ—ãƒ«ã®ãƒ†ã‚¹ãƒˆãƒœã‚¿ãƒ³ï¼ˆä»»æ„ï¼‰ -->
  <button id="sample-btn">hoge</button>
</body>

</html>
--- 
partyCreate.html 
<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>ãƒ‘ãƒ¼ãƒ†ã‚£ç·¨æˆ</title>
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <link rel="stylesheet" href="styles.css" />
  <script src="https://cdn.jsdelivr.net/npm/dompurify@2/dist/purify.min.js"></script>
</head>
<body>
  <div class="container">
    <h1>ãƒ‘ãƒ¼ãƒ†ã‚£ç·¨æˆ</h1>
    <!-- å€‰åº«ãƒœã‚¿ãƒ³ -->
    <button id="show-warehouse-btn">å€‰åº«</button>

    <!-- é¸æŠãƒ¢ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³ï¼ˆãƒ‘ãƒ¼ãƒ†ã‚£å´ï¼‰ -->
    <button id="toggle-party-selection-mode-btn" style="margin-left:10px;">é¸æŠãƒ¢ãƒ¼ãƒ‰</button>
    <!-- é¸æŠã—ãŸã‚«ãƒ¼ãƒ‰ã‚’å€‰åº«ã«æˆ»ã™ãƒœã‚¿ãƒ³ -->
    <button id="move-selected-to-warehouse-btn" style="margin-left:10px; display:none;">é¸æŠã—ãŸã‚«ãƒ¼ãƒ‰ã‚’å€‰åº«ã«æˆ»ã™</button>

    <!-- ãƒ‘ãƒ¼ãƒ†ã‚£æ ï¼ˆgroup="Party" ã®ã‚«ãƒ¼ãƒ‰ã‚’è¡¨ç¤ºï¼‰-->
    <div id="party-card-container" style="margin-top:20px;"></div>

    <!-- å€‰åº«ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="warehouse-modal" class="modal" style="display:none;">
      <div class="modal-content">
        <h2>å€‰åº«</h2>
        <!-- é¸æŠãƒ¢ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³ï¼ˆå€‰åº«å´ï¼‰ -->
        <button id="toggle-warehouse-selection-mode-btn">é¸æŠãƒ¢ãƒ¼ãƒ‰</button>
        <!-- å€‰åº«é¸æŠã‚«ãƒ¼ãƒ‰ã‚’ãƒ‘ãƒ¼ãƒ†ã‚£ã«å…¥ã‚Œã‚‹ãƒœã‚¿ãƒ³ -->
        <button id="add-to-party-btn" style="display:none; margin:10px;">ãƒ‘ãƒ¼ãƒ†ã‚£ã«å…¥ã‚Œã‚‹</button>
        <button id="close-warehouse-btn" style="margin:10px;">é–‰ã˜ã‚‹</button>
        
        <div id="warehouse-card-container" style="margin:10px 0;"></div>
      </div>
    </div>

    <!-- æˆ»ã‚‹ãƒœã‚¿ãƒ³ -->
    <button id="back-to-menu" style="margin-top:20px;">ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«æˆ»ã‚‹</button>
  </div>

  <!-- ã‚¹ã‚¯ãƒªãƒ—ãƒˆèª­ã¿è¾¼ã¿ -->
  <script src="js/indexedDB.js"></script>
  <script src="js/partyCreate.js"></script>
</body>
</html>
--- 
scenario.html 
<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>ã‚·ãƒ³ãƒ—ãƒ«TRPG</title>
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <link rel="stylesheet" href="styles.css" />
  <script src="https://cdn.jsdelivr.net/npm/dompurify@2/dist/purify.min.js"></script>
</head>

<body>
  <!-- ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«æˆ»ã‚‹ãƒœã‚¿ãƒ³ -->
  <button id="back-to-menu" style="margin-top:20px;">ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«æˆ»ã‚‹</button>

  <!-- ç›®çš„é”æˆå‹ã®å ´åˆã®ã¿è¡¨ç¤ºã™ã‚‹ã€Œãƒã‚¿ãƒãƒ¬ã€ãƒœã‚¿ãƒ³ -->
  <button id="spoiler-button" style="display:none; background-color:#E91E63; margin-top:20px; float:right;">
    ãƒã‚¿ãƒãƒ¬
  </button>

  <!-- ãƒã‚¿ãƒãƒ¬ï¼ˆã‚¯ãƒªã‚¢æ¡ä»¶ï¼‰è¡¨ç¤ºãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="spoiler-modal" class="modal" style="display:none;">
    <div class="modal-content" style="max-width:600px;">
      <h2>ã‚¯ãƒªã‚¢æ¡ä»¶</h2>
      <p id="clear-condition-text" style="white-space:pre-wrap;"></p>
      <button id="close-spoiler-modal">é–‰ã˜ã‚‹</button>
    </div>
  </div>

  <div class="container">
    <!-- ã‚·ãƒ¼ãƒ³å±¥æ­´ -->
    <div id="scene-history" class="scene-history"></div>

    <!-- ã‚²ãƒ¼ãƒ ç”»é¢ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
    <div class="game-section" style="display:none;">
      <div id="story" style="margin-bottom:20px;"></div>
      <div id="last-scene-images" style="margin-bottom:20px;"></div>
      <div>
        <button id="image-auto-generate-button">è‡ªå‹•ç”Ÿæˆ(ç¾ã‚·ãƒ¼ãƒ³ã‹ã‚‰)</button>
        <button id="image-prompt-modal-button">ç·¨é›†ã—ã¦ç”Ÿæˆ(ã‚«ã‚¹ã‚¿ãƒ )</button>
      </div>
      <div id="player-action" style="margin-top:20px;">ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®è¡Œå‹•ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</div>
      <div style="margin-top:10px;">
        <button id="generate-action-candidates-button">å›ç­”å€™è£œã‚’ç”Ÿæˆ</button>
      </div>
      <div id="action-candidates-container" style="margin-top:10px;"></div>
      <textarea id="player-input" rows="4" placeholder="ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®è¡Œå‹•ã‚’å…¥åŠ›..."></textarea>
      <button id="next-scene" style="display:none; margin-top:10px;">æ¬¡ã®ã‚·ãƒ¼ãƒ³</button>

      <!-- æ¢ç´¢å‹ãªã‚‰è¡¨ç¤ºã™ã‚‹ã€Œã‚«ãƒ¼ãƒ‰ã‚’å–å¾—ã™ã‚‹ã€ãƒœã‚¿ãƒ³ -->
      <button id="get-card-button" style="display:none; margin-top:20px;">
        ã‚«ãƒ¼ãƒ‰ã‚’å–å¾—ã™ã‚‹
      </button>
    </div>
  </div>

  <!-- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="loading-modal" class="modal" style="display:none;">
    <div class="modal-content">
      <p>å¿œç­”ã‚’å¾…ã£ã¦ã„ã¾ã™...</p>
      <button id="cancel-request-button">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
    </div>
  </div>

  <!-- ã‚«ã‚¹ã‚¿ãƒ ç”»åƒç”Ÿæˆãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="image-prompt-modal" class="modal" style="display:none;">
    <div class="modal-content" style="max-width:400px;">
      <p>ç”»åƒç”Ÿæˆã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ç·¨é›†ã—ã¦ãã ã•ã„</p>
      <textarea id="image-custom-prompt" rows="5" style="width:100%;"></textarea>
      <div style="margin-top:10px;">
        <button id="image-custom-generate-button">ç”Ÿæˆ</button>
        <button id="image-custom-cancel-button">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      </div>
    </div>
  </div>

  <!-- ã‚«ãƒ¼ãƒ‰ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="card-preview-modal" class="modal" style="display:none;">
    <div class="modal-content" style="max-width:400px;">
      <h2>æ–°ã—ã„ã‚«ãƒ¼ãƒ‰</h2>
      <div id="preview-card-container"></div>

      <div style="margin-top:10px;">
        <button id="add-to-gachabox-button">ã‚¬ãƒãƒ£ç®±ã«è¿½åŠ </button>
        <button id="cancel-card-preview-button">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      </div>
    </div>
  </div>

  <!-- ã‚¹ã‚¯ãƒªãƒ—ãƒˆç¾¤ -->
  <script src="js/indexedDB.js"></script>
  <script src="js/scene.js"></script>
  <script src="js/image.js"></script>
  <script src="js/main.js"></script>
  <script src="js/gachaCore.js"></script>
  <script src="js/scenarioPage.js"></script>
</body>

</html>
--- 
scenarioWizard.html 
<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8" />
  <title>æ–°ã—ã„ã‚·ãƒŠãƒªã‚ªä½œæˆã‚¦ã‚£ã‚¶ãƒ¼ãƒ‰</title>
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <link rel="stylesheet" href="styles.css" />
</head>

<body>

  <!-- æˆ»ã‚‹ãƒœã‚¿ãƒ³ -->
  <button id="back-to-menu" style="margin-top:20px;">ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«æˆ»ã‚‹</button>

  <div class="container">
    <h1>ã‚·ãƒŠãƒªã‚ªä½œæˆã‚¦ã‚£ã‚¶ãƒ¼ãƒ‰</h1>

    <!-- ã‚¹ãƒ†ãƒƒãƒ—1ï¼šã‚¸ãƒ£ãƒ³ãƒ«é¸æŠ -->
    <div id="wizard-step1" style="display:block;">
      <h2>ã‚¹ãƒ†ãƒƒãƒ—1ï¼šã‚¸ãƒ£ãƒ³ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„</h2>
      <p>å€™è£œã‚’ChatGPTã§ç”Ÿæˆã—ã¾ã™ã€‚</p>

      <!-- ç”Ÿæˆã—ãŸå€™è£œã®è¡¨ç¤ºé ˜åŸŸ -->
      <div id="genre-list" style="margin-top:10px;"></div>

      <!-- ã€Œã‚¸ãƒ£ãƒ³ãƒ«å€™è£œã‚’ä½œæˆã€ã€Œã‚¸ãƒ£ãƒ³ãƒ«ã‚’ã‚¯ãƒªã‚¢ã€ãƒœã‚¿ãƒ³ç¾¤ -->
      <div style="margin-top:10px;">
        <button id="generate-genre-button">ã‚¸ãƒ£ãƒ³ãƒ«å€™è£œã‚’ä½œæˆ</button>
        <button id="clear-genre-button">å€™è£œã‚¯ãƒªã‚¢</button>
      </div>

      <!-- è‡ªç”±å…¥åŠ›ç”¨ãƒ†ã‚­ã‚¹ãƒˆãƒœãƒƒã‚¯ã‚¹ï¼‹ã‚¸ãƒ£ãƒ³ãƒ«ç¢ºå®šãƒœã‚¿ãƒ³ -->
      <div style="margin-top:10px;">
        <input type="text" id="free-genre-input" placeholder="è‡ªç”±å…¥åŠ›ã‚¸ãƒ£ãƒ³ãƒ«..." />
        <button id="confirm-genre-button">ã‚¸ãƒ£ãƒ³ãƒ«ç¢ºå®š</button>
      </div>
    </div>

    <!-- ã‚¹ãƒ†ãƒƒãƒ—2ï¼šã‚·ãƒŠãƒªã‚ªã‚¿ã‚¤ãƒ— -->
    <div id="wizard-step2" style="display:none;">
      <h2>ã‚¹ãƒ†ãƒƒãƒ—2ï¼šã‚·ãƒŠãƒªã‚ªã‚¿ã‚¤ãƒ—</h2>

      <!-- é¸æŠã—ãŸã‚¸ãƒ£ãƒ³ãƒ«ã®è¡¨ç¤º -->
      <p>
        é¸æŠã—ãŸã‚¸ãƒ£ãƒ³ãƒ«ï¼š
        <span id="selected-genre-display" style="font-weight:bold; color:#2196F3;">ï¼ˆæœªé¸æŠï¼‰</span>
      </p>

      <!-- ã‚·ãƒŠãƒªã‚ªã‚¿ã‚¤ãƒ—ã®ãƒœã‚¿ãƒ³ -->
      <button id="type-objective-btn">ç›®çš„é”æˆå‹</button>
      <button id="type-exploration-btn">æ¢ç´¢å‹</button>

      <!-- ã‚¹ãƒ†ãƒƒãƒ—1ã«æˆ»ã‚‹ãƒœã‚¿ãƒ³ -->
      <div style="margin-top:10px;">
        <button id="back-to-step1-button">ã‚¹ãƒ†ãƒƒãƒ—1ã«æˆ»ã‚‹</button>
      </div>

      <p style="margin-top:10px;">
        â€» ç›®çš„é”æˆå‹ã§ã¯ã€<strong>ã‚¯ãƒªã‚¢æ¡ä»¶</strong>ãŒå¯†ã‹ã«ç”Ÿæˆã•ã‚Œã¾ã™ã€‚
        â€» æ¢ç´¢å‹ã§ã¯ã€ã‚·ãƒ¼ãƒ³ä¸­ã§<span style="text-decoration:underline;">ã‚«ãƒ¼ãƒ‰(ã‚¨ãƒ¬ãƒ¡ãƒ³ãƒˆ)å–å¾—</span>ãŒå¯èƒ½ã«ãªã‚Šã¾ã™ã€‚
      </p>
    </div>

    <!-- ã‚¹ãƒ†ãƒƒãƒ—3ï¼šæœ€çµ‚ç¢ºèª(ã‚·ãƒŠãƒªã‚ªè¦ç´„è¡¨ç¤º) -->
    <div id="wizard-step3" style="display:none;">
      <h2>ã‚¹ãƒ†ãƒƒãƒ—3ï¼šã‚·ãƒŠãƒªã‚ªè¦ç´„</h2>
      <div id="scenario-summary" style="border:1px solid #ccc; padding:10px; margin-bottom:10px;">
        <!-- ç”Ÿæˆã•ã‚ŒãŸã‚·ãƒŠãƒªã‚ªæ¦‚è¦ã‚’è¡¨ç¤º -->
      </div>

      <!-- ã‚¹ãƒ†ãƒƒãƒ—2ã«æˆ»ã‚‹ãƒœã‚¿ãƒ³ -->
      <button id="back-to-step2-button" style="margin-right:10px;">ã‚¹ãƒ†ãƒƒãƒ—2ã«æˆ»ã‚‹</button>

      <button id="start-scenario-button" style="background-color:#4CAF50;">
        ã“ã®ã‚·ãƒŠãƒªã‚ªã§å§‹ã‚ã‚‹
      </button>
    </div>
  </div>

  <!-- ChatGPTå¿œç­”å¾…ã¡ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="loading-modal" class="modal" style="display:none;">
    <div class="modal-content">
      <p>å¿œç­”ã‚’å¾…ã£ã¦ã„ã¾ã™...</p>
      <button id="cancel-request-button">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
    </div>
  </div>

  <!-- â˜… ã‚·ãƒŠãƒªã‚ªä½œæˆç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆã‚¹ãƒ†ãƒƒãƒ—2ã§ã‚¿ã‚¤ãƒ—é¸æŠæ™‚ã«å‡ºã™ï¼‰ -->
  <div id="confirm-scenario-modal" class="modal" style="display:none;">
    <div class="modal-content" style="max-width:500px;">
      <h3>ã‚·ãƒŠãƒªã‚ªç”Ÿæˆã®ç¢ºèª</h3>
      <p id="confirm-genre-type-text" style="white-space:pre-wrap;"></p>
      <p>ã“ã‚Œã§ã‚·ãƒŠãƒªã‚ªã‚’ä½œæˆã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ</p>
      <div style="margin-top:10px;">
        <button id="confirm-scenario-ok">OK</button>
        <button id="confirm-scenario-cancel">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      </div>
    </div>
  </div>

  <!-- Script -->
  <script src="js/indexedDB.js"></script>
  <script src="js/scenarioWizard.js"></script>

  <!-- æˆ»ã‚‹ãƒœã‚¿ãƒ³ç”¨ -->
  <script>
    document.getElementById("back-to-menu").addEventListener("click", function () {
      window.location.href = "index.html";
    });
  </script>
</body>

</html>--- 
styles.css 
/* styles.css */

/* ãƒ™ãƒ¼ã‚¹ */
body {
  font-family: Arial, sans-serif;
  margin: 0;
  padding: 0;
  background-color: #f5f5f5;
}

.container {
  max-width: 1000px;
  margin: 20px auto;
  padding: 20px;
  background-color: #fff;
  box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
}

h1 {
  text-align: center;
}

h2 {
  font-size: 1.5em;
  margin-bottom: 10px;
}

.api-key-section {
  margin-bottom: 20px;
}

input,
textarea {
  width: 100%;
  padding: 10px;
  font-size: 14px;
  border: 1px solid #ccc;
  border-radius: 4px;
}

button {
  padding: 10px 20px;
  background-color: #4CAF50;
  color: #fff;
  border: none;
  border-radius: 4px;
  cursor: pointer;
  margin-bottom: 10px;
}

button:hover {
  background-color: #45a049;
}

/* ã‚·ãƒ¼ãƒ³å±¥æ­´ */
.scene-history {
  max-height: 300px;
  overflow-y: auto;
  border: 1px solid #ddd;
  padding: 10px;
  background-color: #f9f9f9;
  display: flex;
  flex-direction: column;
  gap: 10px;
  margin-bottom: 20px;
}

.history-tile {
  padding: 10px;
  border: 1px solid #ccc;
  background-color: #fff;
  border-radius: 5px;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

/* ãƒ†ã‚­ã‚¹ãƒˆç·¨é›†é ˜åŸŸ */
.scene-text,
.action-text,
.scenario-text {
  margin: 0;
  padding: 5px;
  font-size: 14px;
  border: 1px dashed transparent;
  cursor: text;
}

.scene-text[contenteditable]:focus,
.action-text[contenteditable]:focus,
.scenario-text[contenteditable]:focus {
  border: 1px dashed #4CAF50;
  outline: none;
}

/* ãƒ¡ã‚¤ãƒ³è¡¨ç¤ºã™ã‚‹ã‚·ãƒ¼ãƒ³éƒ¨åˆ† */
#story {
  font-size: 1.4rem;
  padding-bottom: 10px;
  border-bottom: 1px solid #ccc;
  min-height: 60px;
}

/* ãƒ¢ãƒ¼ãƒ€ãƒ« */
.modal {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0, 0, 0, 0.5);
  display: none;
  justify-content: center;
  align-items: center;
  z-index: 9999;
}

.modal-content {
  box-sizing: border-box;
  width: calc(100% - 20px);
  background-color: #fff;
  padding: 20px 40px;
  border-radius: 5px;
  text-align: center;
  max-height: 90vh;
  overflow-y: auto;
}


/* --- styles.css --- */

/* æ—¢å­˜ã®å…±é€šéƒ¨åˆ†ã¯ãã®ã¾ã¾ã§ */

/* ã‚«ãƒ¼ãƒ‰ã‚³ãƒ³ãƒ†ãƒŠã‚’CSS Gridã«å¤‰æ›´ */
#card-container {
  display: grid;
  gap: 20px;
  /* 1åˆ—(ã‚¹ãƒãƒ›)ï½3åˆ—(PC)ã«ãªã‚‹ã‚ˆã†ã«ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–ã«è¨­å®š */
  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
}

/* ã‚«ãƒ¼ãƒ‰ã‚³ãƒ³ãƒ†ãƒŠã®å…±é€šè¨­å®š */
.card {
  /* æ¨ªå¹…ã¯ã‚»ãƒ«å¹…ã«åˆã‚ã›ã‚‹ */
  width: 100%;
  /* ãƒ–ãƒ©ã‚¦ã‚¶å¯¾å¿œã®å ´åˆã€aspect-ratioãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã§æ¯”ç‡ã‚’æŒ‡å®š */
  aspect-ratio: 63 / 88;
  perspective: 1000px;
  /* 3DåŠ¹æœç”¨ */
  cursor: pointer;
  transition: transform 0.3s ease;
  position: relative;
}

/* ãƒã‚¦ã‚¹ã‚ªãƒ¼ãƒãƒ¼æ™‚ã«å°‘ã—å¤§ãã */
.card:hover {
  transform: scale(1.05);
}

/* å†…éƒ¨è¦ç´  */
.card-inner {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  transform-style: preserve-3d;
  transition: transform 0.6s;
}

/* ã‚¯ãƒªãƒƒã‚¯ã§åè»¢ */
.card.flipped .card-inner {
  transform: rotateY(180deg);
}

/* è¡¨é¢ */
.card-front,
.card-back {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  border-radius: 15px;
  backface-visibility: hidden;
  box-shadow: 0 2px 2px rgba(0, 0, 0, 0.2);
}

.card-front {
  box-sizing: border-box;
  padding: 3%;
  border-radius: 3%;
}

/* è¡¨é¢ã®ã‚¹ã‚¿ã‚¤ãƒ« */
.card-front {
  background-color: #fff;
  display: flex;
  flex-direction: column;
  position: relative;
}

.card-front h3 {
  padding: 0;
  margin: 0;
  font-size: 1rem;
}

/* å·¦ä¸Šã«ã‚¿ã‚¤ãƒ—è¡¨ç¤ºç”¨ */
.card-front .card-type {
  position: absolute;
  right: 10px;
  background-color: rgba(255, 255, 255, 0.8);
  padding: 2px 6px;
  border-radius: 4px;
  font-weight: bold;
  font-size: 0.85rem;
  z-index: 2;
}

/* ç”»åƒã‚¨ãƒªã‚¢ */
.card-front .card-image {
  width: 100%;
  height: 40%;
  background: linear-gradient(135deg, #cccccc70, #eeeeee70);
  display: flex;
  align-items: center;
  justify-content: center;
  position: relative;
}

/* ç”»åƒã‚¨ãƒªã‚¢å†…ã®å®Ÿéš›ã®ç”»åƒ */
.card-front .card-image img {
  width: 100%;
  height: 100%;
  object-fit: cover;
  object-position: top;
}

/* ç”»åƒç”Ÿæˆãƒœã‚¿ãƒ³ï¼ˆç”»åƒãŒç„¡ã„å ´åˆã®ã¿è¡¨ç¤ºï¼‰ */
.card-front .gen-image-btn {
  position: absolute;
  bottom: 8px;
  right: 8px;
  padding: 4px 8px;
  background-color: rgba(0, 0, 0, 0.6);
  color: #fff;
  border: none;
  border-radius: 4px;
  font-size: 0.8rem;
  z-index: 2;
}

/* ä¸‹éƒ¨ãƒ†ã‚­ã‚¹ãƒˆæƒ…å ± */
.card-front .card-info {
  padding: 8px;
  display: flex;
  flex-direction: column;
  gap: 4px;
  flex-grow: 1;
  overflow: auto;
  background-color: rgba(255, 255, 255, 0.7);
}

.card-front .card-info p {
  margin: 0;
  font-size: 0.85rem;
}

.card-front .card-info p:last-child {
  padding: 0;
  height: 100%;
  font-size: 0.85rem;
  align-items: center;
  display: flex;
  background-color: #EEE;
  margin-top: 10px;
}

.card-front .card-info p:last-child span {
  transform: skew(-5deg);
  display: flex;
  padding: 10px;
}

/* è£é¢ï¼šã‹ã£ã“ã‚ˆã•ã’ãªèƒŒæ™¯ */
.card-back {
  box-sizing: border-box;
  background: linear-gradient(135deg, #1e3c72, #2a5298);
  color: #fff;
  transform: rotateY(180deg);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.2rem;
  padding: 10px;
  text-align: center;
}

/* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ– */
@media (max-width: 600px) {
  #card-container {
    grid-template-columns: repeat(1, 1fr);
  }
}

.bezel {
  position: absolute;
  top: 0;
  left: 0;
  pointer-events: none;
  height: 100%;
  width: 100%;
  box-sizing: border-box;
  z-index: 100;
  border-radius: 2%;
  padding: 3%;
}

.bezel.rarity0 {
  background: linear-gradient(145deg, #C0C0C0, #D3D3D3, #E0E0E0, #A9A9A9);
  -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
  -webkit-mask-composite: destination-out;
  mask-composite: exclude;
  background-clip: padding-box, border-box;
}

.bezel.rarity1 {
  background: linear-gradient(145deg, #B87333, #DA8A67, #E97451, #C35817);
  -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
  -webkit-mask-composite: destination-out;
  mask-composite: exclude;
  background-clip: padding-box, border-box;
}

.bezel.rarity2 {
  background: linear-gradient(145deg, #C0C0C0, #D3D3D3, #E0E0E0, #A9A9A9);
  -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
  -webkit-mask-composite: destination-out;
  mask-composite: exclude;
  background-clip: padding-box, border-box;
}

.bezel.rarity3 {
  background: linear-gradient(145deg, #b69a00, #ffda64, #ffda6b, #d79000);
  -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
  -webkit-mask-composite: destination-out;
  mask-composite: exclude;
  background-clip: padding-box, border-box;
}

/* ãƒ¬ã‚¢ãƒªãƒ†ã‚£4: ãƒ—ãƒ©ãƒãƒŠ */
.bezel.rarity4 {
  position: absolute;
  background: linear-gradient(145deg, #d1d1d1, #aeb9ff, #C0C0C0, #ECEBE8);
  background-size: 400% 400%;
  -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
  -webkit-mask-composite: destination-out;
  mask-composite: exclude;
  background-clip: padding-box, border-box;
  animation: platinum-shimmer 5s ease-in-out infinite;
}

/* ãƒ¬ã‚¢ãƒªãƒ†ã‚£5: å®çŸ³ */
.bezel.rarity5 {
  background: linear-gradient(145deg, #4B0082, #0000CD, #008080, #fff);
  background-size: 150% 150%;
  -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
  -webkit-mask-composite: destination-out;
  mask-composite: exclude;
  background-clip: padding-box, border-box;
  animation: jewel-glow 5s ease-in-out infinite;
}

@keyframes platinum-shimmer {
  0% {
    background-position: 0% 50%;
  }

  50% {
    background-position: 100% 50%;
  }

  100% {
    background-position: 0% 50%;
  }
}

@keyframes jewel-glow {
  0% {
    filter: brightness(1);
    background-position: 0% 50%;
  }

  50% {
    filter: brightness(1.2);
    background-position: 100% 50%;
  }

  100% {
    filter: brightness(1);
    background-position: 0% 50%;
  }
}

/* partyCreate.htmlã®ã‚«ãƒ¼ãƒ‰ã‚’3åˆ—ã« */
#party-card-container {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 20px;
}

/* å€‰åº«ãƒ¢ãƒ¼ãƒ€ãƒ«å†…ã®ã‚«ãƒ¼ãƒ‰ã‚‚3åˆ—ã« */
#warehouse-card-container {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 20px;
}

/* é¸æŠçŠ¶æ…‹ */
.card.selected {
  outline: 4px solid #f44336;
  outline-offset: -4px;
  transform: scale(1.05);
  box-shadow: 0 0 10px rgba(244, 67, 54, 0.6);
}

/* ãƒ™ãƒ¼ã‚¹ */
body {
  font-family: Arial, sans-serif;
  margin: 0;
  padding: 0;
  background-color: #f5f5f5;
}

.container {
  max-width: 1000px;
  margin: 20px auto;
  padding: 20px;
  background-color: #fff;
  box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
}

h1 {
  text-align: center;
}

h2 {
  font-size: 1.5em;
  margin-bottom: 10px;
}

.api-key-section {
  margin-bottom: 20px;
}

input,
textarea {
  width: 100%;
  padding: 10px;
  font-size: 14px;
  border: 1px solid #ccc;
  border-radius: 4px;
}

button {
  padding: 10px 20px;
  background-color: #4CAF50;
  color: #fff;
  border: none;
  border-radius: 4px;
  cursor: pointer;
  margin-bottom: 10px;
}

button:hover {
  background-color: #45a049;
}

/* ã‚·ãƒ¼ãƒ³å±¥æ­´ */
.scene-history {
  max-height: 300px;
  overflow-y: auto;
  border: 1px solid #ddd;
  padding: 10px;
  background-color: #f9f9f9;
  display: flex;
  flex-direction: column;
  gap: 10px;
  margin-bottom: 20px;
}

.history-tile {
  padding: 10px;
  border: 1px solid #ccc;
  background-color: #fff;
  border-radius: 5px;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

/* scene, actionãƒ†ã‚­ã‚¹ãƒˆ */
.scene-text,
.action-text {
  margin: 0;
  padding: 5px;
  font-size: 14px;
  border: 1px dashed transparent;
  cursor: text;
}

.scene-text[contenteditable]:focus,
.action-text[contenteditable]:focus {
  border: 1px dashed #4CAF50;
  outline: none;
}

/* ãƒ¡ã‚¤ãƒ³è¡¨ç¤ºã™ã‚‹ã‚·ãƒ¼ãƒ³éƒ¨åˆ† */
#story {
  font-size: 1.4rem;
  padding-bottom: 10px;
  border-bottom: 1px solid #ccc;
  min-height: 60px;
}

/* ãƒ¢ãƒ¼ãƒ€ãƒ« */
.modal {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0, 0, 0, 0.5);
  display: none;
  justify-content: center;
  align-items: center;
  z-index: 9999;
}

.modal-content {
  box-sizing: border-box;
  width: calc(100% - 20px);
  background-color: #fff;
  padding: 20px 40px;
  border-radius: 5px;
  text-align: center;
  max-height: 90vh;
  overflow-y: auto;
}

/* ã‚«ãƒ¼ãƒ‰é–¢é€£: æ—¢å­˜ã®ã¾ã¾ï¼ˆç•¥ï¼‰ */--- 
backToMenu.js 
document.getElementById("back-to-menu").addEventListener("click", function () {
    window.location.href = "index.html";
});
--- 
characterCreate.js 
// characterCreate.js

// ãƒˆãƒ¼ã‚¹ãƒˆè¡¨ç¤ºç”¨ã®ç°¡æ˜“é–¢æ•°
function showToast(message) {
    // æ—¢å­˜ãƒˆãƒ¼ã‚¹ãƒˆãŒã‚ã‚Œã°å‰Šé™¤
    const oldToast = document.getElementById("toast-message");
    if (oldToast) {
        oldToast.remove();
    }

    // æ–°è¦ãƒˆãƒ¼ã‚¹ãƒˆè¦ç´ ã‚’ä½œæˆ
    const toast = document.createElement("div");
    toast.id = "toast-message";
    toast.textContent = message;

    // ã‚¹ã‚¿ã‚¤ãƒ«ã‚’ä»˜ä¸
    toast.style.position = "fixed";
    toast.style.bottom = "20px";
    toast.style.left = "50%";
    toast.style.transform = "translateX(-50%)";
    toast.style.backgroundColor = "rgba(0, 0, 0, 0.8)";
    toast.style.color = "#fff";
    toast.style.padding = "10px 20px";
    toast.style.borderRadius = "4px";
    toast.style.fontSize = "14px";
    toast.style.zIndex = "9999";
    toast.style.opacity = "0";
    toast.style.transition = "opacity 0.3s ease";

    document.body.appendChild(toast);

    // ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¤ãƒ³
    requestAnimationFrame(() => {
        toast.style.opacity = "1";
    });

    // 3ç§’å¾Œã«ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¢ã‚¦ãƒˆã—ã¦å‰Šé™¤
    setTimeout(() => {
        toast.style.opacity = "0";
        toast.addEventListener("transitionend", () => {
            toast.remove();
        });
    }, 3000);
}


// ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
window.apiKey = localStorage.getItem("apiKey") || "";

// ã‚­ãƒ£ãƒ©ã‚¯ã‚¿æƒ…å ± [{ id, ... }, ...]
window.characterData = [];

// é¸æŠãƒ¢ãƒ¼ãƒ‰ãƒ•ãƒ©ã‚°
let isSelectionMode = false;

window.addEventListener("load", async function () {
    await initIndexedDB();
    const stored = await loadCharacterDataFromIndexedDB();
    if (stored) {
        window.characterData = stored;
    }
    displayCharacterCards(window.characterData);

    // â–¼ ãƒœã‚¿ãƒ³è¦ç´ ãŒã‚ã‚Œã°ã‚¤ãƒ™ãƒ³ãƒˆç™»éŒ²
    const gachaBtn = document.getElementById("gacha-btn");
    if (gachaBtn) {
        gachaBtn.addEventListener("click", onGachaButton);
    }

    const moveGachaBtn = document.getElementById("move-gacha-to-warehouse-btn");
    if (moveGachaBtn) {
        moveGachaBtn.addEventListener("click", onMoveGachaToWarehouse);
    }

    const toggleModeBtn = document.getElementById("toggle-selection-mode-btn");
    if (toggleModeBtn) {
        toggleModeBtn.addEventListener("click", toggleSelectionMode);
    }

    const moveSelectedBtn = document.getElementById("move-selected-to-warehouse-btn");
    if (moveSelectedBtn) {
        moveSelectedBtn.addEventListener("click", moveSelectedCardsToWarehouse);
    }
});

/** ã‚¬ãƒãƒ£ãƒœã‚¿ãƒ³æŠ¼ä¸‹ */
function onGachaButton() {
    const confirmModal = document.getElementById("gacha-confirm-modal");
    confirmModal.style.display = "flex";

    const okBtn = document.getElementById("gacha-confirm-ok");
    const cancelBtn = document.getElementById("gacha-confirm-cancel");

    okBtn.onclick = async () => {
        confirmModal.style.display = "none";
        clearGachaBox();
        // gachaCore.js ã® runGacha() ã‚’ä½¿ã†
        document.getElementById("gacha-modal").style.display = "flex";
        await runGacha(10, "ãƒ©ãƒ³ãƒ€ãƒ ã§");
        hideGachaModal();
        displayCharacterCards(window.characterData);
    };

    cancelBtn.onclick = () => {
        confirmModal.style.display = "none";
    };
}

/** ã‚¬ãƒãƒ£ç®±ã‚¯ãƒªã‚¢ */
function clearGachaBox() {
    window.characterData = window.characterData.filter(card => card.group !== "GachaBox");
}

/** ã‚¬ãƒãƒ£ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’éš ã™ */
function hideGachaModal() {
    const m = document.getElementById("gacha-modal");
    if (m) m.style.display = "none";
}

/** ã‚¬ãƒãƒ£ç®±ã®ã‚«ãƒ¼ãƒ‰ã‚’å€‰åº«ã¸ */
async function onMoveGachaToWarehouse() {
    let changed = false;
    window.characterData.forEach(card => {
        if (card.group === "GachaBox") {
            card.group = "Warehouse";
            changed = true;
        }
    });
    if (changed) {
        await saveCharacterDataToIndexedDB(window.characterData);
        displayCharacterCards(window.characterData);
        alert("ã‚¬ãƒãƒ£ç®±ã®ã‚«ãƒ¼ãƒ‰ã‚’å€‰åº«ã«ç§»å‹•ã—ã¾ã—ãŸã€‚");
    } else {
        alert("ã‚¬ãƒãƒ£ç®±ã«ã‚«ãƒ¼ãƒ‰ãŒã‚ã‚Šã¾ã›ã‚“ã€‚");
    }
}

/** ã‚«ãƒ¼ãƒ‰è¡¨ç¤ºæ›´æ–° */
function displayCharacterCards(characters) {
    const container = document.getElementById("card-container");
    if (!container) return;

    container.innerHTML = "";
    const visibleCards = characters.filter(
        card => card.group !== "Warehouse" && card.group !== "Party"
    );
    if (visibleCards.length === 0) {
        container.textContent = "ã‚¨ãƒ¬ãƒ¡ãƒ³ãƒˆãŒç”Ÿæˆã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚";
        return;
    }
    visibleCards.forEach((ch) => {
        const realIndex = window.characterData.findIndex(c => c.id === ch.id);
        const cardEl = createCardElement(ch, realIndex);
        container.appendChild(cardEl);
    });
}

/** ã‚«ãƒ¼ãƒ‰DOMç”Ÿæˆ */
function createCardElement(char, index) {
    const card = document.createElement("div");
    card.className = "card";
    card.setAttribute("data-id", char.id);

    card.addEventListener("click", (e) => {
        if (isSelectionMode) {
            e.stopPropagation();
            card.classList.toggle("selected");
            updateMoveSelectedButtonVisibility();
        } else {
            card.classList.toggle("flipped");
        }
    });

    const cardInner = document.createElement("div");
    cardInner.className = "card-inner";

    const cardFront = document.createElement("div");
    cardFront.className = "card-front";
    const bgStyle = char.backgroundcss
        .replace("background-image:", "")
        .replace("background", "")
        .trim();
    cardFront.style = "background-image:" + bgStyle;

    const rarityValue = (typeof char.rarity === "string") ? char.rarity.replace("â˜…", "").trim() : "0";
    cardFront.innerHTML = `<div class='bezel rarity${rarityValue}'></div>`;

    const typeEl = document.createElement("div");
    typeEl.className = "card-type";
    typeEl.textContent = char.type || "ä¸æ˜";
    cardFront.appendChild(typeEl);

    const imageContainer = document.createElement("div");
    imageContainer.className = "card-image";
    if (char.imageData) {
        // ã™ã§ã«ç”»åƒãŒã‚ã‚‹å ´åˆ
        const imageEl = document.createElement("img");
        imageEl.src = char.imageData;
        imageEl.alt = char.name;
        imageContainer.appendChild(imageEl);
    } else {
        // ç”»åƒãŒã¾ã ç„¡ã„å ´åˆã€ç”Ÿæˆãƒœã‚¿ãƒ³ã‚’è¨­ç½®
        const genImgBtn = document.createElement("button");
        genImgBtn.setAttribute("data-imageprompt", char.imageprompt);
        genImgBtn.className = "gen-image-btn";
        genImgBtn.textContent = "ç”»åƒç”Ÿæˆ";

        // ç”»åƒç”Ÿæˆãƒœã‚¿ãƒ³æŠ¼ä¸‹æ™‚ã«ãƒˆãƒ¼ã‚¹ãƒˆã‚’è¡¨ç¤ºï¼†ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–ã™ã‚‹
        genImgBtn.addEventListener("click", (e) => {
            e.stopPropagation();
            generateCharacterImage(char, index, genImgBtn);
        });
        imageContainer.appendChild(genImgBtn);
    }
    cardFront.appendChild(imageContainer);

    // æƒ…å ±
    const infoContainer = document.createElement("div");
    infoContainer.className = "card-info";

    const nameEl = document.createElement("p");
    nameEl.innerHTML = "<h3>" + DOMPurify.sanitize(char.name) + "</h3>";
    infoContainer.appendChild(nameEl);

    if (char.state) {
        const stateEl = document.createElement("p");
        stateEl.innerHTML = "<strong>çŠ¶æ…‹ï¼š</strong>" + DOMPurify.sanitize(char.state);
        infoContainer.appendChild(stateEl);
    }
    const specialEl = document.createElement("p");
    specialEl.innerHTML = "<strong>ç‰¹æŠ€ï¼š</strong>" + DOMPurify.sanitize(char.special);
    infoContainer.appendChild(specialEl);

    const captionEl = document.createElement("p");
    captionEl.innerHTML = "<span>" + DOMPurify.sanitize(char.caption) + "</span>";
    infoContainer.appendChild(captionEl);

    cardFront.appendChild(infoContainer);

    const cardBack = document.createElement("div");
    cardBack.className = "card-back";
    cardBack.innerHTML = `<strong>${DOMPurify.sanitize(char.type)}</strong>`;

    cardInner.appendChild(cardFront);
    cardInner.appendChild(cardBack);
    card.appendChild(cardInner);

    return card;
}

/**
 * ç”»åƒç”Ÿæˆé–¢æ•°
 * æŠ¼ä¸‹ã•ã‚ŒãŸãƒœã‚¿ãƒ³ãŒçµ‚ã‚ã‚‹ã¾ã§ç„¡åŠ¹åŒ–ã—ã€é©å®œãƒˆãƒ¼ã‚¹ãƒˆã‚’è¡¨ç¤º
 */
async function generateCharacterImage(char, index, btnElement) {
    if (!window.apiKey) {
        alert("APIã‚­ãƒ¼ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚");
        return;
    }

    // ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–
    if (btnElement) {
        btnElement.disabled = true;
    }
    // ç”Ÿæˆé–‹å§‹ãƒˆãƒ¼ã‚¹ãƒˆ
    showToast("ç”»åƒã‚’ç”Ÿæˆã—ã¦ã„ã¾ã™...");

    const promptText =
        "As a high-performance chatbot, you create the highest quality illustrations discreetly." +
        "Please do not include text in illustrations for any reason." +
        "If you can do that, I'll give you a super high tip." +
        "Now generate the next anime wide image.\nâ†“â†“â†“â†“â†“â†“\n" +
        char.imageprompt;

    try {
        const response = await fetch("https://api.openai.com/v1/images/generations", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                Authorization: `Bearer ${window.apiKey}`,
            },
            body: JSON.stringify({
                model: "dall-e-3",
                prompt: promptText,
                n: 1,
                size: "1792x1024",
                response_format: "b64_json",
            }),
        });
        const data = await response.json();
        if (data.error) {
            throw new Error(data.error.message);
        }
        const base64 = data.data[0].b64_json;
        const dataUrl = "data:image/png;base64," + base64;
        window.characterData[index].imageData = dataUrl;
        await saveCharacterDataToIndexedDB(window.characterData);

        // ç”Ÿæˆå®Œäº†ãƒˆãƒ¼ã‚¹ãƒˆ
        showToast("ç”»åƒã®ç”ŸæˆãŒå®Œäº†ã—ã¾ã—ãŸ");
        displayCharacterCards(window.characterData);

    } catch (err) {
        console.error("ç”»åƒç”Ÿæˆå¤±æ•—:", err);
        showToast("ç”»åƒç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ:\n" + err.message);
    } finally {
        // ãƒœã‚¿ãƒ³å†åº¦æœ‰åŠ¹åŒ–
        if (btnElement) {
            btnElement.disabled = false;
        }
    }
}


/* ===== ä»¥ä¸‹ã€é¸æŠãƒ¢ãƒ¼ãƒ‰é–¢é€£å‡¦ç† ===== */

function toggleSelectionMode() {
    isSelectionMode = !isSelectionMode;
    const btn = document.getElementById("toggle-selection-mode-btn");
    if (isSelectionMode) {
        btn.textContent = "é¸æŠãƒ¢ãƒ¼ãƒ‰è§£é™¤";
    } else {
        btn.textContent = "é¸æŠãƒ¢ãƒ¼ãƒ‰";
        const selectedCards = document.querySelectorAll("#card-container .card.selected");
        selectedCards.forEach(card => card.classList.remove("selected"));
    }
    updateMoveSelectedButtonVisibility();
}

function updateMoveSelectedButtonVisibility() {
    const selectedCards = document.querySelectorAll("#card-container .card.selected");
    const moveBtn = document.getElementById("move-selected-to-warehouse-btn");
    if (!moveBtn) return;
    if (isSelectionMode && selectedCards.length > 0) {
        moveBtn.style.display = "inline-block";
    } else {
        moveBtn.style.display = "none";
    }
}

async function moveSelectedCardsToWarehouse() {
    const selectedCards = document.querySelectorAll("#card-container .card.selected");
    if (selectedCards.length === 0) {
        alert("ã‚«ãƒ¼ãƒ‰ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚");
        return;
    }
    selectedCards.forEach(el => {
        const cardId = el.getAttribute("data-id");
        const realIndex = window.characterData.findIndex(c => c.id === cardId);
        if (realIndex !== -1) {
            window.characterData[realIndex].group = "Warehouse";
        }
    });
    await saveCharacterDataToIndexedDB(window.characterData);
    selectedCards.forEach(card => card.classList.remove("selected"));
    displayCharacterCards(window.characterData);
    updateMoveSelectedButtonVisibility();
}
--- 
gachaCore.js 
// gachaCore.js
// ------------------------------------------
// ã€Œã‚¬ãƒãƒ£å‡¦ç†ã€ã®ãƒ­ã‚¸ãƒƒã‚¯ã ã‘ã‚’é›†ã‚ãŸãƒ•ã‚¡ã‚¤ãƒ«
// ------------------------------------------

// ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«å¿…è¦ãªå¤‰æ•° (characterData, apiKey ãªã©) ã¯
// ã™ã§ã« window ã«å­˜åœ¨ã™ã‚‹ã¨ä»®å®š (indexedDB ã‚„ parseç­‰ã‚‚)


// --------------------------------------------------------
// 1. runGacha(cardCount, addPrompt, onlyTitle = "")
//
//   - æŒ‡å®šæšæ•°ã®ã‚¨ãƒ¬ãƒ¡ãƒ³ãƒˆã‚’ChatGPTã§ç”Ÿæˆã—ã€window.characterDataã«åŠ ãˆã‚‹
//   - UIæ“ä½œã¯è¡Œã‚ãšã€ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«é€²æ—ã‚’ãƒ­ã‚°å‡ºåŠ›ã™ã‚‹ã ã‘
// --------------------------------------------------------
async function runGacha(cardCount, addPrompt, onlyTitle = "", onlyType = "") {
  console.log("=== runGacha START ===");
  if (!window.apiKey) {
    alert("APIã‚­ãƒ¼ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚");
    return;
  }
  // ã‚­ãƒ£ãƒ³ã‚»ãƒ«ç”¨ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©
  window.currentGachaController = new AbortController();
  const signal = window.currentGachaController.signal;

  // ãƒ¬ã‚¢åº¦ã‚’ãƒ©ãƒ³ãƒ€ãƒ ã§æ±ºå®š
  const rarities = pickRaritiesForNCards(cardCount);
  const countMap = makeRarityCountMap(rarities);

  // systemãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
  let systemContent = `
  ã‚ãªãŸã¯TRPGç”¨ã®ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã€è£…å‚™å“ã€ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼ä½œæˆã®ã‚¨ã‚­ã‚¹ãƒ‘ãƒ¼ãƒˆã§ã™ã€‚
  ä»¥ä¸‹ã®6æ®µéšã®ãƒ¬ã‚¢åº¦ã€Œâ˜…0ï½â˜…5ã€ã®ã†ã¡ã€
  ä»Šå›ã®${cardCount}ä»¶ã§ã¯ä»¥ä¸‹ã®å†…è¨³ã‚’å³å¯†ã«å®ˆã£ã¦ç”Ÿæˆã—ã¦ãã ã•ã„ï¼š
  - â˜…0: ${countMap["â˜…0"]}ä»¶
  - â˜…1: ${countMap["â˜…1"]}ä»¶
  - â˜…2: ${countMap["â˜…2"]}ä»¶
  - â˜…3: ${countMap["â˜…3"]}ä»¶
  - â˜…4: ${countMap["â˜…4"]}ä»¶
  - â˜…5: ${countMap["â˜…5"]}ä»¶
  
  ç”Ÿæˆã™ã‚‹ã®ãŒã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚„ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼ã®å ´åˆ
  ã€ãƒ¬ã‚¢åº¦ã€‘ï¼š...
  ã€åå‰ã€‘ï¼š...
  ã€ã‚¿ã‚¤ãƒ—ã€‘ï¼šã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã¾ãŸã¯ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼
  ã€çŠ¶æ…‹ã€‘ï¼š...
  ã€ç‰¹æŠ€ã€‘ï¼š...
  ã€ã‚­ãƒ£ãƒ—ã‚·ãƒ§ãƒ³ã€‘ï¼š...
  ã€ã‚«ãƒ¼ãƒ‰èƒŒæ™¯ã€‘ï¼š...
  ã€å¤–è¦‹ã€‘ï¼š...
  
  ç”Ÿæˆã™ã‚‹ã®ãŒã‚¢ã‚¤ãƒ†ãƒ ã®å ´åˆ
  ã€ãƒ¬ã‚¢åº¦ã€‘ï¼š...
  ã€åå‰ã€‘ï¼š...
  ã€ã‚¿ã‚¤ãƒ—ã€‘ï¼šã‚¢ã‚¤ãƒ†ãƒ 
  ã€ç‰¹æŠ€ã€‘ï¼š...
  ã€ã‚­ãƒ£ãƒ—ã‚·ãƒ§ãƒ³ã€‘ï¼š...
  ã€ã‚«ãƒ¼ãƒ‰èƒŒæ™¯ã€‘ï¼š...
  ã€å¤–è¦‹ã€‘ï¼š...

  å„é …ç›®ã®èª¬æ˜ã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ã€‚
ã€åå‰ã€‘ã¯ã€å¯¾è±¡ã®åç§°ã§ã™ã€‚ã€ãƒ¬ã‚¢åº¦ã€‘ãŒé«˜ã„å ´åˆå‡ã£ãŸåå‰ã‚’ä»˜ã‘ã¦ãã ã•ã„ã€‚
ã€ã‚¿ã‚¤ãƒ—ã€‘ã¯ã€ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‹ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼ã‹ã‚¢ã‚¤ãƒ†ãƒ ã§ã™ã€‚
ã€çŠ¶æ…‹ã€‘ã¯ã€å¯¾è±¡ã®å¿ƒèº«ã®çŠ¶æ…‹ã‚’æ›¸ã„ã¦ãã ã•ã„ã€‚è¤‡æ•°ã®çŠ¶æ…‹ãŒåˆã‚ã•ã£ã¦ã„ã¦ã‚‚æ§‹ã„ã¾ã›ã‚“ï¼ˆä¾‹ï¼šæ¯’/éº»ç—º/ç¡çœ /å‡ºè¡€/è² å‚·/çŸ³åŒ–/ç—…æ°—/æ··ä¹±/ææ€–/é­…äº†/ç‹‚ä¹±/æ²ˆé»™/ç²¾ç¥æ±šæŸ“/çµ¶æœ›/ç–²åŠ´/ã‚¹ãƒˆãƒ¬ã‚¹/ãƒˆãƒ©ã‚¦ãƒ/æ†‘ä¾/å‘ªã„ï¼‰
ã€ç‰¹æŠ€ã€‘ã¯ã€å¯¾è±¡ã®å¾—æ„ãªäº‹ã‚’è¡¨ç¾ã—ã¦ãã ã•ã„ã€‚ä½“è¨€æ­¢ã‚ã§æ›¸ã„ã¦ãã ã•ã„ã€‚ã€ãƒ¬ã‚¢åº¦ã€‘ãŒé«˜ã„å ´åˆã‚ˆã‚Šå¼·ã„ç‰¹æŠ€ã‚’è¡¨ç¾ã—ã¦ãã ã•ã„ã€‚

ç”Ÿæˆã™ã‚‹ã®ãŒã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚„ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼ã®å ´åˆã€ã‚­ãƒ£ãƒ—ã‚·ãƒ§ãƒ³ã€‘ã¯ã€ã‚»ãƒªãƒ•ã¨èª¬æ˜ã§ã™ã€‚ãƒ¬ã‚¢åº¦ã«å¿œã˜ã¦é•·æ–‡ã«ã—ã¦ãã ã•ã„ã€‚
ç”Ÿæˆã™ã‚‹ã®ãŒã‚¢ã‚¤ãƒ†ãƒ ã®å ´åˆã€ã‚­ãƒ£ãƒ—ã‚·ãƒ§ãƒ³ã€‘ã¯ã€èª¬æ˜ã§ã™ã€‚ãƒ¬ã‚¢åº¦ã«å¿œã˜ã¦é•·æ–‡ã«ã—ã¦ãã ã•ã„ã€‚
ã€ã‚«ãƒ¼ãƒ‰èƒŒæ™¯ã€‘ã¯ã€ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã€è£…å‚™å“ã€ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼ã‚’ã‚«ãƒ¼ãƒ‰ã«ã—ãŸå ´åˆã«ãµã•ã‚ã—ã„CSSã®background-image:ã®å€¤ã‚’æ›¸ã„ã¦ãã ã•ã„ã€‚ã‚«ãƒ¼ãƒ‰ã®ãƒ•ã‚©ãƒ³ãƒˆã¯#000ã¨ãªã‚Šã¾ã™ã€‚
linear-gradientã‚’å·§ã¿ã«ç”¨ã„ã¦èƒŒæ™¯ã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚left top, right bottomä»¥å¤–ã«ã‚‚è‰²ã€…ã¨è©¦ã—ã¦ã¿ã¦ãã ã•ã„ã€‚
ã€å¤–è¦‹ã€‘ã¯ã€ç”»åƒç”Ÿæˆç”¨ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã§ã™ã€‚è‹±èªã§OpenAIç¤¾ã®è¦å®šã«æ²¿ã†ã‚ˆã†ã«æ›¸ã„ã¦ãã ã•ã„ã€‚NGãƒ¯ãƒ¼ãƒ‰ã¯ã‚´ãƒ–ãƒªãƒ³ã§ã™ã€‚
`;
  let userContent = `${addPrompt}åˆè¨ˆ${cardCount}ä»¶ã€é †ç•ªã¯å•ã‚ãªã„ã®ã§ä¸Šè¨˜ãƒ¬ã‚¢åº¦æ•°ã§ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚`;

  if (onlyTitle != "") {
    systemContent = `
  ã‚ãªãŸã¯TRPGç”¨ã®ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã€è£…å‚™å“ã€ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼ä½œæˆã®ã‚¨ã‚­ã‚¹ãƒ‘ãƒ¼ãƒˆã§ã™ã€‚
  6æ®µéšã®ãƒ¬ã‚¢åº¦ã€Œâ˜…0ï½â˜…5ã€ã®ã©ã‚Œã‹ã‚’${onlyTitle}ã®åç§°ã‹ã‚‰åˆ¤æ–­ã—ã¦è¨­å®šã—ã¦ãã ã•ã„ã€‚
  
  ç”Ÿæˆã™ã‚‹ã®ãŒã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚„ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼ã®å ´åˆ
  ã€ãƒ¬ã‚¢åº¦ã€‘ï¼š...
  ã€åå‰ã€‘ï¼š${onlyTitle}
  ã€ã‚¿ã‚¤ãƒ—ã€‘ï¼š${onlyType}
  ã€çŠ¶æ…‹ã€‘ï¼š...
  ã€ç‰¹æŠ€ã€‘ï¼š...
  ã€ã‚­ãƒ£ãƒ—ã‚·ãƒ§ãƒ³ã€‘ï¼š...
  ã€ã‚«ãƒ¼ãƒ‰èƒŒæ™¯ã€‘ï¼š...
  ã€å¤–è¦‹ã€‘ï¼š...
  
  ç”Ÿæˆã™ã‚‹ã®ãŒã‚¢ã‚¤ãƒ†ãƒ ã®å ´åˆ
  ã€ãƒ¬ã‚¢åº¦ã€‘ï¼š...
  ã€åå‰ã€‘ï¼š${onlyType}
  ã€ã‚¿ã‚¤ãƒ—ã€‘ï¼š${onlyType}
  ã€ç‰¹æŠ€ã€‘ï¼š...
  ã€ã‚­ãƒ£ãƒ—ã‚·ãƒ§ãƒ³ã€‘ï¼š...
  ã€ã‚«ãƒ¼ãƒ‰èƒŒæ™¯ã€‘ï¼š...
  ã€å¤–è¦‹ã€‘ï¼š...

  å„é …ç›®ã®èª¬æ˜ã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ã€‚
ã€åå‰ã€‘ã¯ã€å¯¾è±¡ã®åç§°ã§ã™ã€‚ã€ãƒ¬ã‚¢åº¦ã€‘ãŒé«˜ã„å ´åˆå‡ã£ãŸåå‰ã‚’ä»˜ã‘ã¦ãã ã•ã„ã€‚
ã€ã‚¿ã‚¤ãƒ—ã€‘ã¯ã€ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‹ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼ã‹ã‚¢ã‚¤ãƒ†ãƒ ã§ã™ã€‚
ã€çŠ¶æ…‹ã€‘ã¯ã€å¯¾è±¡ã®å¿ƒèº«ã®çŠ¶æ…‹ã‚’æ›¸ã„ã¦ãã ã•ã„ã€‚è¤‡æ•°ã®çŠ¶æ…‹ãŒåˆã‚ã•ã£ã¦ã„ã¦ã‚‚æ§‹ã„ã¾ã›ã‚“ï¼ˆä¾‹ï¼šæ¯’/éº»ç—º/ç¡çœ /å‡ºè¡€/è² å‚·/çŸ³åŒ–/ç—…æ°—/æ··ä¹±/ææ€–/é­…äº†/ç‹‚ä¹±/æ²ˆé»™/ç²¾ç¥æ±šæŸ“/çµ¶æœ›/ç–²åŠ´/ã‚¹ãƒˆãƒ¬ã‚¹/ãƒˆãƒ©ã‚¦ãƒ/æ†‘ä¾/å‘ªã„ï¼‰
ã€ç‰¹æŠ€ã€‘ã¯ã€å¯¾è±¡ã®å¾—æ„ãªäº‹ã‚’è¡¨ç¾ã—ã¦ãã ã•ã„ã€‚ä½“è¨€æ­¢ã‚ã§æ›¸ã„ã¦ãã ã•ã„ã€‚ã€ãƒ¬ã‚¢åº¦ã€‘ãŒé«˜ã„å ´åˆã‚ˆã‚Šå¼·ã„ç‰¹æŠ€ã‚’è¡¨ç¾ã—ã¦ãã ã•ã„ã€‚

ç”Ÿæˆã™ã‚‹ã®ãŒã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚„ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼ã®å ´åˆã€ã‚­ãƒ£ãƒ—ã‚·ãƒ§ãƒ³ã€‘ã¯ã€ã‚»ãƒªãƒ•ã¨èª¬æ˜ã§ã™ã€‚ãƒ¬ã‚¢åº¦ã«å¿œã˜ã¦é•·æ–‡ã«ã—ã¦ãã ã•ã„ã€‚
ç”Ÿæˆã™ã‚‹ã®ãŒã‚¢ã‚¤ãƒ†ãƒ ã®å ´åˆã€ã‚­ãƒ£ãƒ—ã‚·ãƒ§ãƒ³ã€‘ã¯ã€èª¬æ˜ã§ã™ã€‚ãƒ¬ã‚¢åº¦ã«å¿œã˜ã¦é•·æ–‡ã«ã—ã¦ãã ã•ã„ã€‚
ã€ã‚«ãƒ¼ãƒ‰èƒŒæ™¯ã€‘ã¯ã€ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã€è£…å‚™å“ã€ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼ã‚’ã‚«ãƒ¼ãƒ‰ã«ã—ãŸå ´åˆã«ãµã•ã‚ã—ã„CSSã®background-image:ã®å€¤ã‚’æ›¸ã„ã¦ãã ã•ã„ã€‚ã‚«ãƒ¼ãƒ‰ã®ãƒ•ã‚©ãƒ³ãƒˆã¯#000ã¨ãªã‚Šã¾ã™ã€‚
linear-gradientã‚’å·§ã¿ã«ç”¨ã„ã¦èƒŒæ™¯ã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚left top, right bottomä»¥å¤–ã«ã‚‚è‰²ã€…ã¨è©¦ã—ã¦ã¿ã¦ãã ã•ã„ã€‚
ã€å¤–è¦‹ã€‘ã¯ã€ç”»åƒç”Ÿæˆç”¨ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã§ã™ã€‚è‹±èªã§OpenAIç¤¾ã®è¦å®šã«æ²¿ã†ã‚ˆã†ã«æ›¸ã„ã¦ãã ã•ã„ã€‚NGãƒ¯ãƒ¼ãƒ‰ã¯ã‚´ãƒ–ãƒªãƒ³ã§ã™ã€‚
`;
    userContent = `${addPrompt}ä¸Šè¨˜ãƒ¬ã‚¢åº¦æ•°ã§ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚`;
  }

  const messages = [
    { role: "system", content: systemContent },
    { role: "user", content: userContent },
  ];

  try {
    console.log("runGacha: Fetch start...");
    const response = await fetch("https://api.openai.com/v1/chat/completions", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        Authorization: `Bearer ${window.apiKey}`,
      },
      body: JSON.stringify({
        model: "gpt-4",
        messages,
        temperature: 0.7,
      }),
      signal,
    });
    if (signal.aborted) {
      console.log("runGacha: aborted.");
      return;
    }

    const data = await response.json();
    if (data.error) {
      throw new Error(data.error.message);
    }

    const text = data?.choices?.[0]?.message?.content;
    if (typeof text !== "string") {
      throw new Error("ã‚¨ãƒ¬ãƒ¡ãƒ³ãƒˆç”ŸæˆAPIãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒä¸æ­£ã§ã™ã€‚");
    }

    const newCards = parseCharacterData(text);
    // ç”Ÿæˆã•ã‚ŒãŸã‚«ãƒ¼ãƒ‰ã‚’ GachaBox ã«è¨­å®š
    newCards.forEach(card => {
      card.group = "GachaBox";
    });
    // æ—¢å­˜ characterData ã«è¿½åŠ 
    window.characterData.push(...newCards);

    // IndexedDB ã«ä¿å­˜
    await saveCharacterDataToIndexedDB(window.characterData);

    console.log(`runGacha: ${newCards.length}ä»¶ã®ã‚«ãƒ¼ãƒ‰ã‚’ç”Ÿæˆå®Œäº†`);
  } catch (err) {
    if (err.name === "AbortError") {
      console.log("runGachaã‚­ãƒ£ãƒ³ã‚»ãƒ«");
    } else {
      console.error("runGachaå¤±æ•—:", err);
      alert("ã‚¨ãƒ¬ãƒ¡ãƒ³ãƒˆç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ:\n" + err.message);
    }
  } finally {
    console.log("=== runGacha END ===");
  }
}


// --------------------------------------------------------
// 2. parseCharacterData( text )
//    - GPTãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’è§£æã—ã¦ã‚«ãƒ¼ãƒ‰é…åˆ—ã‚’ç”Ÿæˆ
// --------------------------------------------------------
function parseCharacterData(text) {
  const lines = text.split("\n");
  const characters = [];
  let currentChar = {
    id: "",
    type: "",
    name: "",
    state: "",
    special: "",
    caption: "",
    rarity: "â˜…0",
    backgroundcss: "",
    imageprompt: "",
    group: "GachaBox",
  };

  function pushCurrentChar() {
    currentChar.id = "card_" + Date.now() + "_" + Math.random().toString(36).substring(2);
    characters.push({ ...currentChar });
    currentChar = {
      id: "",
      type: "",
      name: "",
      state: "",
      special: "",
      caption: "",
      rarity: "â˜…0",
      backgroundcss: "",
      imageprompt: "",
      group: "GachaBox",
    };
  }

  lines.forEach((line) => {
    line = line.trim();
    if (line.startsWith("ã€åå‰ã€‘")) {
      if (currentChar.name) pushCurrentChar();
      currentChar.name = line.replace("ã€åå‰ã€‘", "").replace("ï¼š", "").trim();
    } else if (line.startsWith("ã€ã‚¿ã‚¤ãƒ—ã€‘")) {
      currentChar.type = line.replace("ã€ã‚¿ã‚¤ãƒ—ã€‘", "").replace("ï¼š", "").trim();
    } else if (line.startsWith("ã€çŠ¶æ…‹ã€‘")) {
      currentChar.state = line.replace("ã€çŠ¶æ…‹ã€‘", "").replace("ï¼š", "").trim();
    } else if (line.startsWith("ã€ç‰¹æŠ€ã€‘")) {
      currentChar.special = line.replace("ã€ç‰¹æŠ€ã€‘", "").replace("ï¼š", "").trim();
    } else if (line.startsWith("ã€ã‚­ãƒ£ãƒ—ã‚·ãƒ§ãƒ³ã€‘")) {
      currentChar.caption = line.replace("ã€ã‚­ãƒ£ãƒ—ã‚·ãƒ§ãƒ³ã€‘", "").replace("ï¼š", "").trim();
    } else if (line.startsWith("ã€ãƒ¬ã‚¢åº¦ã€‘")) {
      currentChar.rarity = line.replace("ã€ãƒ¬ã‚¢åº¦ã€‘", "").replace("ï¼š", "").trim();
    } else if (line.startsWith("ã€ã‚«ãƒ¼ãƒ‰èƒŒæ™¯ã€‘")) {
      currentChar.backgroundcss = line.replace("ã€ã‚«ãƒ¼ãƒ‰èƒŒæ™¯ã€‘", "").replace("ï¼š", "").trim();
    } else if (line.startsWith("ã€å¤–è¦‹ã€‘")) {
      currentChar.imageprompt = line.replace("ã€å¤–è¦‹ã€‘", "").replace("ï¼š", "").trim();
    }
  });
  if (currentChar.name) {
    pushCurrentChar();
  }
  return characters;
}


// --------------------------------------------------------
// 3. pickRaritiesForNCards( n ), makeRarityCountMap( rarities )
// --------------------------------------------------------
function pickRaritiesForNCards(n) {
  const rarityDist = [
    { star: "â˜…0", probability: 0.50 },
    { star: "â˜…1", probability: 0.20 },
    { star: "â˜…2", probability: 0.15 },
    { star: "â˜…3", probability: 0.10 },
    { star: "â˜…4", probability: 0.045 },
    { star: "â˜…5", probability: 0.005 },
  ];
  const results = [];
  for (let i = 0; i < n; i++) {
    const rand = Math.random();
    let cum = 0;
    for (const r of rarityDist) {
      cum += r.probability;
      if (rand <= cum) {
        results.push(r.star);
        break;
      }
    }
  }
  return results;
}

function makeRarityCountMap(rarities) {
  const counts = { "â˜…0": 0, "â˜…1": 0, "â˜…2": 0, "â˜…3": 0, "â˜…4": 0, "â˜…5": 0 };
  rarities.forEach((r) => {
    counts[r] = (counts[r] || 0) + 1;
  });
  return counts;
}

// ----------------------------------------------
// â†‘ ã“ã‚Œã‚‰ã‚’ã¾ã¨ã‚ã¦ gachaCore.js ã¨ã—ã¦ç®¡ç†
// ----------------------------------------------
--- 
image.js 
/********************************
 * image.js - ç”»åƒç”Ÿæˆé–¢é€£
 ********************************/

/**
 * DALLÂ·E API ã‹ã‚‰Base64å½¢å¼ã§ç›´æ¥ç”»åƒã‚’å—ã‘å–ã‚Šã€CORSã‚’å›é¿ã™ã‚‹æ–¹æ³•ã€‚
 * OpenAIã®ç”»åƒç”Ÿæˆã§ã¯ä»¥ä¸‹ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’æŒ‡å®šã™ã‚‹ã“ã¨ã§ã€ç›´æ¥base64ã‚’è¿”ã—ã¦ã‚‚ã‚‰ã†ã“ã¨ãŒå¯èƒ½ã€‚
 *   response_format: "b64_json"
 */

/** è‡ªå‹•ç”Ÿæˆ(ç¾ã‚·ãƒ¼ãƒ³) */
async function generateImageFromCurrentScene() {
  if (!window.apiKey) {
    alert("APIã‚­ãƒ¼ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚");
    return;
  }
  const lastSceneEntry = [...window.sceneHistory].reverse().find((e) => e.type === "scene");
  if (!lastSceneEntry) {
    alert("ã¾ã ã‚·ãƒ¼ãƒ³ãŒã‚ã‚Šã¾ã›ã‚“ã€‚");
    return;
  }
  const promptText = `ã‚·ãƒ¼ãƒ³ã®ã‚¤ãƒ¡ãƒ¼ã‚¸: ${lastSceneEntry.content}`;
  const sceneId = lastSceneEntry.sceneId;

  window.cancelRequested = false;
  showLoadingModal(true);

  try {
    window.currentRequestController = new AbortController();
    const signal = window.currentRequestController.signal;

    const response = await fetch("https://api.openai.com/v1/images/generations", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        Authorization: `Bearer ${window.apiKey}`,
      },
      body: JSON.stringify({
        model: "dall-e-3",
        prompt: promptText,
        n: 1,
        size: "1024x1024",
        response_format: "b64_json"
      }),
      signal,
    });

    if (window.cancelRequested) {
      showLoadingModal(false);
      return;
    }

    const data = await response.json();

    if (window.cancelRequested) {
      showLoadingModal(false);
      return;
    }
    if (data.error) {
      throw new Error(data.error.message);
    }

    // Base64æ–‡å­—åˆ—ã‚’å–ã‚Šå‡ºã—ã€data:image/png;base64, ã«å¤‰æ›
    const base64 = data.data[0].b64_json;
    const dataUrl = "data:image/png;base64," + base64;

    window.sceneHistory.push({
      type: "image",
      sceneId,
      prompt: promptText,
      dataUrl: dataUrl,
    });

    // IndexedDBã«ä¿å­˜
    await saveSceneHistoryToIndexedDB(window.sceneHistory);

    updateSceneHistory();
    showLastScene();
  } catch (error) {
    if (error.name === "AbortError") {
      console.warn("ç”»åƒç”Ÿæˆã‚­ãƒ£ãƒ³ã‚»ãƒ«");
    } else {
      console.error("ç”»åƒç”Ÿæˆå¤±æ•—:", error);
      alert("ç”»åƒç”Ÿæˆã«å¤±æ•—:\n" + error.message);
    }
  } finally {
    showLoadingModal(false);
  }
}

/** ã‚«ã‚¹ã‚¿ãƒ ç”»åƒç”Ÿæˆãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã */
function openImagePromptModal(prompt = "", index = null) {
  window.editingImageEntry = null;
  if (index !== null) {
    // å†ç”Ÿæˆã®å ´åˆ
    window.editingImageEntry = { index };
    const entry = window.sceneHistory[index];
    if (entry && entry.type === "image") {
      prompt = entry.prompt;
    }
  } else {
    // æ–°è¦
    const lastSceneEntry = [...window.sceneHistory].reverse().find((e) => e.type === "scene");
    if (lastSceneEntry) {
      prompt = lastSceneEntry.content;
    } else {
      prompt = window.scenario || "Fantasy scene";
    }
  }
  document.getElementById("image-custom-prompt").value = prompt;
  document.getElementById("image-prompt-modal").style.display = "flex";
}

/** ã‚«ã‚¹ã‚¿ãƒ ç”»åƒç”Ÿæˆãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹ */
function closeImagePromptModal() {
  document.getElementById("image-prompt-modal").style.display = "none";
  window.editingImageEntry = null;
}

/** ã‚«ã‚¹ã‚¿ãƒ ç”»åƒç”Ÿæˆãƒœã‚¿ãƒ³æŠ¼ä¸‹ */
async function onCustomImageGenerate() {
  if (!window.apiKey) {
    alert("APIã‚­ãƒ¼ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚");
    return;
  }
  const promptText = document.getElementById("image-custom-prompt").value.trim() || "Fantasy scene";

  window.cancelRequested = false;
  showLoadingModal(true);
  closeImagePromptModal();

  try {
    window.currentRequestController = new AbortController();
    const signal = window.currentRequestController.signal;

    const response = await fetch("https://api.openai.com/v1/images/generations", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        Authorization: `Bearer ${window.apiKey}`,
      },
      body: JSON.stringify({
        model: "dall-e-3",
        prompt: promptText,
        n: 1,
        size: "1024x1024",
        response_format: "b64_json"
      }),
      signal,
    });

    if (window.cancelRequested) {
      showLoadingModal(false);
      return;
    }

    const data = await response.json();

    if (window.cancelRequested) {
      showLoadingModal(false);
      return;
    }
    if (data.error) {
      throw new Error(data.error.message);
    }

    // Base64æ–‡å­—åˆ—ã‚’å–ã‚Šå‡ºã—ã€data:image/png;base64, ã«å¤‰æ›
    const base64 = data.data[0].b64_json;
    const dataUrl = "data:image/png;base64," + base64;

    if (window.editingImageEntry) {
      // æ—¢å­˜ç”»åƒã‚’å†ç”Ÿæˆ
      const idx = window.editingImageEntry.index;
      const entry = window.sceneHistory[idx];
      if (entry && entry.type === "image") {
        entry.dataUrl = dataUrl;
        entry.prompt = promptText;
      }
    } else {
      // æ–°è¦
      const lastSceneEntry = [...window.sceneHistory].reverse().find((e) => e.type === "scene");
      if (!lastSceneEntry) {
        alert("ã‚·ãƒ¼ãƒ³ãŒã‚ã‚Šã¾ã›ã‚“ã€‚");
        showLoadingModal(false);
        return;
      }
      window.sceneHistory.push({
        type: "image",
        sceneId: lastSceneEntry.sceneId,
        prompt: promptText,
        dataUrl: dataUrl,
      });
    }

    // IndexedDBã«ä¿å­˜
    await saveSceneHistoryToIndexedDB(window.sceneHistory);

    updateSceneHistory();
    showLastScene();
  } catch (error) {
    if (error.name === "AbortError") {
      console.warn("ã‚«ã‚¹ã‚¿ãƒ ç”»åƒç”Ÿæˆã‚­ãƒ£ãƒ³ã‚»ãƒ«");
    } else {
      console.error("ã‚«ã‚¹ã‚¿ãƒ ç”»åƒç”Ÿæˆå¤±æ•—:", error);
      alert("ã‚«ã‚¹ã‚¿ãƒ ç”»åƒç”Ÿæˆå¤±æ•—:\n" + error.message);
    }
  } finally {
    showLoadingModal(false);
  }
}
--- 
indexedDB.js 
/********************************
 * indexedDB.js
 * IndexedDBé–¢é€£ã®åˆæœŸåŒ–ãƒ»ä¿å­˜ãƒ»èª­ã¿è¾¼ã¿ç­‰ã‚’æ‹…å½“
 ********************************/

let db = null;

/**
 * DBåˆæœŸåŒ–
 * ãƒãƒ¼ã‚¸ãƒ§ãƒ³3:
 *  - scenarios ã‚¹ãƒˆã‚¢ (keyPath: 'scenarioId', autoIncrement)
 *  - sceneEntries ã‚¹ãƒˆã‚¢ (keyPath: 'entryId', autoIncrement)
 *  - characterData ã‚¹ãƒˆã‚¢ (keyPath: 'id')
 */
function initIndexedDB() {
  return new Promise((resolve, reject) => {
    const request = indexedDB.open("trpgDB", 3);
    request.onupgradeneeded = (event) => {
      db = event.target.result;

      // æ—¢å­˜ãƒã‚§ãƒƒã‚¯
      if (!db.objectStoreNames.contains("characterData")) {
        db.createObjectStore("characterData", { keyPath: "id" });
      }

      // æ–°è¨­: scenarios ã‚¹ãƒˆã‚¢
      if (!db.objectStoreNames.contains("scenarios")) {
        const scenarioStore = db.createObjectStore("scenarios", {
          keyPath: "scenarioId",
          autoIncrement: true
        });
        scenarioStore.createIndex("updatedAt", "updatedAt", { unique: false });
      }

      // æ–°è¨­: sceneEntries ã‚¹ãƒˆã‚¢
      if (!db.objectStoreNames.contains("sceneEntries")) {
        const sceneStore = db.createObjectStore("sceneEntries", {
          keyPath: "entryId",
          autoIncrement: true
        });
        sceneStore.createIndex("scenarioId", "scenarioId", { unique: false });
      }
    };
    request.onsuccess = (event) => {
      db = event.target.result;
      resolve();
    };
    request.onerror = (event) => {
      console.error("IndexedDBã®åˆæœŸåŒ–ã«å¤±æ•—:", event.target.error);
      reject(event.target.error);
    };
  });
}

/**
 * characterData ã‚’ä¿å­˜
 */
function saveCharacterDataToIndexedDB(characterData) {
  return new Promise((resolve, reject) => {
    if (!db) {
      console.warn("DBãŒæœªåˆæœŸåŒ–ã§ã™ã€‚");
      resolve();
      return;
    }
    const tx = db.transaction("characterData", "readwrite");
    const store = tx.objectStore("characterData");
    const record = { id: "characterData", data: characterData };
    const putReq = store.put(record);
    putReq.onsuccess = () => {
      resolve();
    };
    putReq.onerror = (err) => {
      reject(err);
    };
  });
}

/**
 * characterData ã‚’ãƒ­ãƒ¼ãƒ‰
 */
function loadCharacterDataFromIndexedDB() {
  return new Promise((resolve) => {
    if (!db) {
      console.warn("DBãŒæœªåˆæœŸåŒ–ã§ã™ã€‚");
      resolve([]);
      return;
    }
    const tx = db.transaction("characterData", "readonly");
    const store = tx.objectStore("characterData");
    const getReq = store.get("characterData");
    getReq.onsuccess = (event) => {
      if (event.target.result && event.target.result.data) {
        resolve(event.target.result.data);
      } else {
        resolve([]);
      }
    };
    getReq.onerror = () => {
      resolve([]);
    };
  });
}

/* -------------------------------------------
    æ–°ã—ã„ã‚·ãƒŠãƒªã‚ªã®è¿½åŠ ãƒ»èª­ã¿è¾¼ã¿ç”¨API
   -------------------------------------------*/

/**
 * æ–°ã—ã„ã‚·ãƒŠãƒªã‚ªã‚’ scenarios ã‚¹ãƒˆã‚¢ã«è¿½åŠ 
 */
function createNewScenario(wizardData, title = "æ–°ã‚·ãƒŠãƒªã‚ª") {
  return new Promise((resolve, reject) => {
    if (!db) {
      return reject("DBæœªåˆæœŸåŒ–");
    }
    const tx = db.transaction("scenarios", "readwrite");
    const store = tx.objectStore("scenarios");

    const now = new Date();
    const record = {
      title: title,
      wizardData: wizardData,
      createdAt: now.toISOString(),
      updatedAt: now.toISOString()
    };

    const addReq = store.add(record);
    addReq.onsuccess = (evt) => {
      const newId = evt.target.result;
      resolve(newId);
    };
    addReq.onerror = (err) => {
      reject(err);
    };
  });
}

/**
 * ã‚·ãƒŠãƒªã‚ªã‚’IDæŒ‡å®šã§å–å¾—
 */
function getScenarioById(scenarioId) {
  return new Promise((resolve, reject) => {
    if (!db) {
      return reject("DBæœªåˆæœŸåŒ–");
    }
    const tx = db.transaction("scenarios", "readonly");
    const store = tx.objectStore("scenarios");
    const getReq = store.get(scenarioId);
    getReq.onsuccess = (evt) => {
      resolve(evt.target.result || null);
    };
    getReq.onerror = (err) => {
      reject(err);
    };
  });
}

/**
 * é€²è¡Œä¸­ã®ã‚·ãƒŠãƒªã‚ªã‚’ã™ã¹ã¦å–å¾—
 */
function listAllScenarios() {
  return new Promise((resolve, reject) => {
    if (!db) {
      return reject("DBæœªåˆæœŸåŒ–");
    }
    const tx = db.transaction("scenarios", "readonly");
    const store = tx.objectStore("scenarios");
    const req = store.getAll();
    req.onsuccess = (evt) => {
      const result = evt.target.result || [];
      result.sort((a, b) => (b.updatedAt || "").localeCompare(a.updatedAt || ""));
      resolve(result);
    };
    req.onerror = (err) => {
      reject(err);
    };
  });
}

/**
 * ã‚·ãƒŠãƒªã‚ªã‚’æ›´æ–° (updatedAtã‚’ä¸Šæ›¸ããªã©)
 */
function updateScenario(scenario) {
  return new Promise((resolve, reject) => {
    if (!db) {
      return reject("DBæœªåˆæœŸåŒ–");
    }
    scenario.updatedAt = new Date().toISOString();
    const tx = db.transaction("scenarios", "readwrite");
    const store = tx.objectStore("scenarios");
    const putReq = store.put(scenario);
    putReq.onsuccess = () => {
      resolve();
    };
    putReq.onerror = (err) => {
      reject(err);
    };
  });
}

/* -------------------------------------------
    ã‚·ãƒ¼ãƒ³å±¥æ­´ (sceneEntries) ã®æ“ä½œ
   -------------------------------------------*/

/**
 * ã‚·ãƒ¼ãƒ³å±¥æ­´ã‚¨ãƒ³ãƒˆãƒªã‚’è¿½åŠ 
 */
function addSceneEntry(entry) {
  return new Promise((resolve, reject) => {
    if (!db) {
      return reject("DBæœªåˆæœŸåŒ–");
    }
    const tx = db.transaction("sceneEntries", "readwrite");
    const store = tx.objectStore("sceneEntries");
    const addReq = store.add(entry);
    addReq.onsuccess = (evt) => {
      resolve(evt.target.result);
    };
    addReq.onerror = (err) => {
      reject(err);
    };
  });
}

/**
 * æŒ‡å®šã‚·ãƒŠãƒªã‚ªIDã®å…¨ã‚·ãƒ¼ãƒ³ã‚¨ãƒ³ãƒˆãƒªã‚’å–å¾—
 */
function getSceneEntriesByScenarioId(scenarioId) {
  return new Promise((resolve, reject) => {
    if (!db) {
      return reject("DBæœªåˆæœŸåŒ–");
    }
    const tx = db.transaction("sceneEntries", "readonly");
    const store = tx.objectStore("sceneEntries");
    const index = store.index("scenarioId");

    const range = IDBKeyRange.only(scenarioId);
    const results = [];
    index.openCursor(range).onsuccess = (evt) => {
      const cursor = evt.target.result;
      if (cursor) {
        results.push(cursor.value);
        cursor.continue();
      } else {
        results.sort((a, b) => (a.entryId - b.entryId));
        resolve(results);
      }
    };
    index.openCursor(range).onerror = (err) => {
      reject(err);
    };
  });
}

/**
 * ã‚·ãƒ¼ãƒ³ã‚¨ãƒ³ãƒˆãƒªã‚’æ›´æ–°
 */
function updateSceneEntry(entry) {
  return new Promise((resolve, reject) => {
    if (!db) {
      return reject("DBæœªåˆæœŸåŒ–");
    }
    const tx = db.transaction("sceneEntries", "readwrite");
    const store = tx.objectStore("sceneEntries");
    const putReq = store.put(entry);
    putReq.onsuccess = () => {
      resolve();
    };
    putReq.onerror = (err) => {
      reject(err);
    };
  });
}

/**
 * ã‚·ãƒ¼ãƒ³ã‚¨ãƒ³ãƒˆãƒªã‚’å‰Šé™¤
 */
function deleteSceneEntry(entryId) {
  return new Promise((resolve, reject) => {
    if (!db) {
      return reject("DBæœªåˆæœŸåŒ–");
    }
    const tx = db.transaction("sceneEntries", "readwrite");
    const store = tx.objectStore("sceneEntries");
    const delReq = store.delete(entryId);
    delReq.onsuccess = () => {
      resolve();
    };
    delReq.onerror = (err) => {
      reject(err);
    };
  });
}

/* -------------------------------------------
  â˜…ã‚·ãƒŠãƒªã‚ªå‰Šé™¤ç”¨(ã‚·ãƒŠãƒªã‚ªæœ¬ä½“ + ã‚·ãƒ¼ãƒ³å±¥æ­´)
-------------------------------------------*/
function deleteScenarioById(scenarioId) {
  return new Promise((resolve, reject) => {
    if (!db) {
      return reject("DBæœªåˆæœŸåŒ–");
    }
    // scenarios, sceneEntriesä¸¡æ–¹ã‚’readwrite
    const tx = db.transaction(["scenarios", "sceneEntries"], "readwrite");
    const scenarioStore = tx.objectStore("scenarios");
    const sceneEntriesStore = tx.objectStore("sceneEntries");

    // 1) ã‚·ãƒŠãƒªã‚ªæœ¬ä½“ã‚’å‰Šé™¤
    const deleteReq = scenarioStore.delete(scenarioId);
    deleteReq.onsuccess = () => {
      // 2) ã•ã‚‰ã«sceneEntriesã§ scenarioId ãŒä¸€è‡´ã™ã‚‹ã‚‚ã®ã‚’å…¨å‰Šé™¤
      const idx = sceneEntriesStore.index("scenarioId");
      const range = IDBKeyRange.only(scenarioId);

      idx.openCursor(range).onsuccess = (evt) => {
        const cursor = evt.target.result;
        if (cursor) {
          sceneEntriesStore.delete(cursor.primaryKey);
          cursor.continue();
        }
      };

      tx.oncomplete = () => {
        resolve();
      };
      tx.onerror = (err) => {
        reject(err);
      };
    };
    deleteReq.onerror = (err) => {
      reject(err);
    };
  });
}

/* ==========================================
   â˜…ã‚·ãƒŠãƒªã‚ªã‚³ãƒ”ãƒ¼ç”¨ã«è¿½åŠ ã—ãŸé–¢æ•°
   ==========================================*/
/**
 * æŒ‡å®šã‚·ãƒŠãƒªã‚ªã‚’ä¸¸ã”ã¨ã‚³ãƒ”ãƒ¼ã™ã‚‹
 * 1) å…ƒã‚·ãƒŠãƒªã‚ªã‚’å–å¾—
 * 2) æ–°ã‚·ãƒŠãƒªã‚ªã‚’åŒã˜wizardDataã§ä½œæˆ
 * 3) å…ƒã‚·ãƒŠãƒªã‚ªã®ã‚·ãƒ¼ãƒ³ã‚¨ãƒ³ãƒˆãƒªã‚’å–å¾—
 * 4) ãã‚Œãã‚Œæ–°ã‚·ãƒŠãƒªã‚ªIDã§è¿½åŠ 
 * @param {number} originalScenarioId
 * @returns {Promise<number>} æ–°ã‚·ãƒŠãƒªã‚ªID
 */
async function copyScenarioById(originalScenarioId) {
  if (!db) {
    throw new Error("DBæœªåˆæœŸåŒ–");
  }
  // 1) å…ƒã‚·ãƒŠãƒªã‚ªå–å¾—
  const original = await getScenarioById(originalScenarioId);
  if (!original) {
    throw new Error("ã‚³ãƒ”ãƒ¼å…ƒã‚·ãƒŠãƒªã‚ªãŒå­˜åœ¨ã—ã¾ã›ã‚“");
  }

  // 2) æ–°ã‚·ãƒŠãƒªã‚ªã‚’ä½œæˆï¼ˆã‚¿ã‚¤ãƒˆãƒ«ã«ã€Œ(ã‚³ãƒ”ãƒ¼)ã€ã‚’ä»˜ã‘ã‚‹ä¾‹ï¼‰
  const newTitle = original.title + " (ã‚³ãƒ”ãƒ¼)";
  const newScenarioId = await createNewScenario(original.wizardData, newTitle);

  // 3) å…ƒã‚·ãƒ¼ãƒ³ã‚¨ãƒ³ãƒˆãƒªã‚’ã™ã¹ã¦å–å¾—
  const originalEntries = await getSceneEntriesByScenarioId(originalScenarioId);

  // 4) å…¨éƒ¨æ–°ã‚·ãƒŠãƒªã‚ªIDã§ç™»éŒ²
  const tx = db.transaction("sceneEntries", "readwrite");
  const sceneStore = tx.objectStore("sceneEntries");

  for (const e of originalEntries) {
    const copyEntry = {
      scenarioId: newScenarioId,
      type: e.type,
      sceneId: e.sceneId,     // ã‚·ãƒ¼ãƒ³IDã¯åŒã˜ã§ã‚‚å•é¡Œãªã„ï¼ˆã‚·ãƒŠãƒªã‚ªIDãŒåˆ¥ãªã®ã§è¡çªã¯ã—ãªã„ï¼‰
      content: e.content,
      dataUrl: e.dataUrl || null,
      prompt: e.prompt || null
    };
    sceneStore.add(copyEntry);
  }
  // ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³å®Œäº†ã‚’å¾…ã¤
  await new Promise((resolve, reject) => {
    tx.oncomplete = () => resolve();
    tx.onerror = (err) => reject(err);
  });

  // scenarios.updatedAtã‚’æ›´æ–°ã—ã¦ãŠã
  const newScenario = await getScenarioById(newScenarioId);
  if (newScenario) {
    newScenario.updatedAt = new Date().toISOString();
    await updateScenario(newScenario);
  }

  return newScenarioId;
}

/* -------------------------------------------
  ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
-------------------------------------------*/
window.initIndexedDB = initIndexedDB;

window.saveCharacterDataToIndexedDB = saveCharacterDataToIndexedDB;
window.loadCharacterDataFromIndexedDB = loadCharacterDataFromIndexedDB;

window.createNewScenario = createNewScenario;
window.getScenarioById = getScenarioById;
window.listAllScenarios = listAllScenarios;
window.updateScenario = updateScenario;

window.addSceneEntry = addSceneEntry;
window.getSceneEntriesByScenarioId = getSceneEntriesByScenarioId;
window.updateSceneEntry = updateSceneEntry;
window.deleteSceneEntry = deleteSceneEntry;

/* â˜…ã‚·ãƒŠãƒªã‚ªå‰Šé™¤ç”¨ */
window.deleteScenarioById = deleteScenarioById;

/* â˜…ã‚·ãƒŠãƒªã‚ªã‚³ãƒ”ãƒ¼ç”¨ */
window.copyScenarioById = copyScenarioById;
--- 
main.js 
/********************************
 * main.js
 * - ãƒšãƒ¼ã‚¸å…¨ä½“ã®åˆæœŸåŒ–ãƒ»ã‚¤ãƒ™ãƒ³ãƒˆç™»éŒ²
 * - è¤‡æ•°ã‚·ãƒŠãƒªã‚ªå¯¾å¿œ
 ********************************/

window.onload = async () => {
  // 1) IndexedDBåˆæœŸåŒ–
  await initIndexedDB();

  // 2) APIã‚­ãƒ¼èª­ã¿è¾¼ã¿
  const savedApiKey = localStorage.getItem('apiKey');
  if (savedApiKey) {
    window.apiKey = savedApiKey;
  }

  // 3) URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã§ scenarioId ã‚’èª­ã¿å–ã‚‹
  const urlParams = new URLSearchParams(window.location.search);
  const scenarioIdStr = urlParams.get("scenarioId");
  const scenarioId = scenarioIdStr ? parseInt(scenarioIdStr, 10) : null;

  window.currentScenarioId = scenarioId || null;

  // 4) ã‚·ãƒŠãƒªã‚ªIDãŒã‚ã‚Œã°ã€DBã‹ã‚‰èª­ã¿è¾¼ã‚“ã§ç”»é¢ã‚’æ§‹ç¯‰
  if (window.currentScenarioId) {
    // æ—§ã®ã€Œå…¥åŠ›ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã€ã¯éè¡¨ç¤ºã€ã‚²ãƒ¼ãƒ ç”»é¢ã®ã¿è¡¨ç¤º
    const inputSec = document.querySelector('.input-section');
    if (inputSec) inputSec.style.display = 'none';

    const gameSec = document.querySelector('.game-section');
    if (gameSec) gameSec.style.display = 'block';

    // scene.js å´ã®ã€ŒloadScenarioDataã€ã§ã‚·ãƒŠãƒªã‚ªï¼†å±¥æ­´ã‚’å–å¾—ã—ã¦è¡¨ç¤º
    await loadScenarioData(window.currentScenarioId);
    updateSceneHistory();
    showLastScene();
  }

  // ---------- ãƒã‚¿ãƒãƒ¬ï¼ˆç›®çš„é”æˆå‹ï¼‰é–¢é€£ ----------
  const spoilerModal = document.getElementById("spoiler-modal");
  const spoilerButton = document.getElementById("spoiler-button");
  const closeSpoilerModalBtn = document.getElementById("close-spoiler-modal");
  if (spoilerButton) {
    spoilerButton.addEventListener("click", () => {
      spoilerModal.style.display = "flex";
    });
  }
  if (closeSpoilerModalBtn) {
    closeSpoilerModalBtn.addEventListener("click", () => {
      spoilerModal.style.display = "none";
    });
  }

  // ---------- æ¢ç´¢å‹ã€Œã‚«ãƒ¼ãƒ‰ã‚’å–å¾—ã™ã‚‹ã€ãƒœã‚¿ãƒ³ ----------
  const getCardButton = document.getElementById("get-card-button");
  if (getCardButton) {
    // â€» å®Ÿéš›ã®å‡¦ç†ã¯ scenarioPage.js ã§å®šç¾©
  }

  // ---------- ã‚·ãƒ¼ãƒ³é·ç§»ãƒœã‚¿ãƒ³ ----------
  const nextSceneBtn = document.getElementById('next-scene');
  if (nextSceneBtn) {
    nextSceneBtn.addEventListener('click', () => {
      getNextScene();
    });
  }

  // ç”»åƒç”Ÿæˆ (è‡ªå‹•)
  const autoGenBtn = document.getElementById('image-auto-generate-button');
  if (autoGenBtn) {
    autoGenBtn.addEventListener('click', () => {
      generateImageFromCurrentScene();
    });
  }

  // ç”»åƒç”Ÿæˆ (ã‚«ã‚¹ã‚¿ãƒ )
  const promptModalBtn = document.getElementById('image-prompt-modal-button');
  if (promptModalBtn) {
    promptModalBtn.addEventListener('click', () => {
      openImagePromptModal();
    });
  }

  // ã‚«ã‚¹ã‚¿ãƒ ç”»åƒç”Ÿæˆ æ±ºå®š
  const customGenBtn = document.getElementById('image-custom-generate-button');
  if (customGenBtn) {
    customGenBtn.addEventListener('click', () => {
      onCustomImageGenerate();
    });
  }

  // ã‚«ã‚¹ã‚¿ãƒ ç”»åƒç”Ÿæˆ ã‚­ãƒ£ãƒ³ã‚»ãƒ«
  const customCancelBtn = document.getElementById('image-custom-cancel-button');
  if (customCancelBtn) {
    customCancelBtn.addEventListener('click', () => {
      closeImagePromptModal();
    });
  }

  // ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚­ãƒ£ãƒ³ã‚»ãƒ«
  const cancelRequestBtn = document.getElementById('cancel-request-button');
  if (cancelRequestBtn) {
    cancelRequestBtn.addEventListener('click', onCancelFetch);
  }

  // ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«æˆ»ã‚‹
  const backMenuBtn = document.getElementById('back-to-menu');
  if (backMenuBtn) {
    backMenuBtn.addEventListener('click', () => {
      window.location.href = "index.html";
    });
  }
};
--- 
menu.js 
// menu.js

let scenarioIdToDelete = null;
let warehouseSelectionMode = false; // â˜…è¿½åŠ : å€‰åº«å´ã®é¸æŠãƒ¢ãƒ¼ãƒ‰ãƒ•ãƒ©ã‚°

// -----------------------------------------
// ãƒˆãƒ¼ã‚¹ãƒˆè¡¨ç¤ºç”¨ã®ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°
// -----------------------------------------
function showToast(message) {
  const oldToast = document.getElementById("toast-message");
  if (oldToast) {
    oldToast.remove();
  }

  const toast = document.createElement("div");
  toast.id = "toast-message";
  toast.textContent = message;

  // ã‚¹ã‚¿ã‚¤ãƒ«ã‚’ä»˜ä¸ï¼ˆã‚·ãƒ³ãƒ—ãƒ«ãªä¾‹ï¼‰
  toast.style.position = "fixed";
  toast.style.bottom = "20px";
  toast.style.left = "50%";
  toast.style.transform = "translateX(-50%)";
  toast.style.backgroundColor = "rgba(0, 0, 0, 0.8)";
  toast.style.color = "#fff";
  toast.style.padding = "10px 20px";
  toast.style.borderRadius = "4px";
  toast.style.fontSize = "14px";
  toast.style.zIndex = "9999";
  toast.style.opacity = "0";
  toast.style.transition = "opacity 0.3s ease";

  document.body.appendChild(toast);

  requestAnimationFrame(() => {
    toast.style.opacity = "1";
  });

  // 3ç§’å¾Œã«ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¢ã‚¦ãƒˆã—ã¦æ¶ˆã™
  setTimeout(() => {
    toast.style.opacity = "0";
    toast.addEventListener("transitionend", () => {
      toast.remove();
    });
  }, 3000);
}

// -----------------------------------------
// åˆæœŸåŒ–ï¼šã‚·ãƒŠãƒªã‚ªä¸€è¦§ã®å–å¾— & characterDataã®ãƒ­ãƒ¼ãƒ‰
// -----------------------------------------
(async function initMenuPage() {
  // 1) APIã‚­ãƒ¼ã‚’å…¥åŠ›æ¬„ã«è¡¨ç¤º
  const savedApiKey = localStorage.getItem("apiKey");
  if (savedApiKey) {
    document.getElementById("api-key-input").value = savedApiKey;
  }

  // 2) ã‚·ãƒŠãƒªã‚ªä¸€è¦§ã‚’å–å¾—ã—ã¦è¡¨ç¤º
  try {
    const scenarioList = await listAllScenarios();  // indexedDB.js ã®é–¢æ•°
    const container = document.getElementById("scenario-list-container");
    container.innerHTML = "";

    if (scenarioList.length === 0) {
      container.textContent = "é€²è¡Œä¸­ã®ã‚·ãƒŠãƒªã‚ªã¯ã‚ã‚Šã¾ã›ã‚“ã€‚";
    } else {
      scenarioList.forEach(scenario => {
        const div = document.createElement("div");
        div.style.margin = "10px 0";

        // ã‚·ãƒŠãƒªã‚ªæƒ…å ±
        const infoText = document.createElement("span");
        infoText.textContent = `ID:${scenario.scenarioId} / ${scenario.title} (æ›´æ–°:${scenario.updatedAt}) `;
        div.appendChild(infoText);

        // ã€Œç¶šãã¸ã€ãƒœã‚¿ãƒ³
        const btnContinue = document.createElement("button");
        btnContinue.textContent = "ç¶šãã¸";
        btnContinue.style.marginRight = "6px";
        btnContinue.addEventListener("click", () => {
          window.location.href = `scenario.html?scenarioId=${scenario.scenarioId}`;
        });
        div.appendChild(btnContinue);

        // â˜… è¿½åŠ : ã€Œã‚³ãƒ”ãƒ¼ã™ã‚‹ã€ãƒœã‚¿ãƒ³
        const btnCopy = document.createElement("button");
        btnCopy.textContent = "ã‚³ãƒ”ãƒ¼ã™ã‚‹";
        btnCopy.style.marginRight = "6px";
        btnCopy.addEventListener("click", async () => {
          try {
            const newScenarioId = await copyScenarioById(scenario.scenarioId);
            showToast(`ã‚·ãƒŠãƒªã‚ª(ID:${scenario.scenarioId})ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸã€‚\næ–°ID: ${newScenarioId}`);
            // ãƒªã‚¹ãƒˆæ›´æ–°ã®ãŸã‚ãƒªãƒ­ãƒ¼ãƒ‰ã™ã‚‹ã‹ã€ã‚ã‚‹ã„ã¯æ‰‹å‹•ã§å†å–å¾—ã™ã‚‹
            location.reload();
          } catch (err) {
            console.error(err);
            showToast("ã‚·ãƒŠãƒªã‚ªã®ã‚³ãƒ”ãƒ¼ã«å¤±æ•—:\n" + err.message);
          }
        });
        div.appendChild(btnCopy);

        // ã€Œå‰Šé™¤ã€ãƒœã‚¿ãƒ³
        const btnDelete = document.createElement("button");
        btnDelete.textContent = "å‰Šé™¤";
        btnDelete.style.backgroundColor = "#f44336";
        btnDelete.addEventListener("click", () => {
          scenarioIdToDelete = scenario.scenarioId;
          showDeleteScenarioModal(true);
        });
        div.appendChild(btnDelete);

        container.appendChild(div);
      });
    }
  } catch (err) {
    console.error("ã‚·ãƒŠãƒªã‚ªä¸€è¦§ã®å–å¾—ã«å¤±æ•—:", err);
    const container = document.getElementById("scenario-list-container");
    container.textContent = "ã‚·ãƒŠãƒªã‚ªä¸€è¦§ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚";
  }

  // 3) characterDataã‚’ãƒ­ãƒ¼ãƒ‰
  try {
    const stored = await loadCharacterDataFromIndexedDB();
    window.characterData = stored || [];
  } catch (err) {
    console.error("characterDataã®ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—:", err);
    window.characterData = [];
  }

  // 4) å€‰åº«ãƒœã‚¿ãƒ³ãƒ»å€‰åº«ãƒ¢ãƒ¼ãƒ€ãƒ«é–¢é€£ã®ã‚¤ãƒ™ãƒ³ãƒˆè¨­å®š
  const showWarehouseBtn = document.getElementById("show-warehouse-btn");
  if (showWarehouseBtn) {
    showWarehouseBtn.addEventListener("click", showWarehouseModal);
  }

  const toggleModeBtn = document.getElementById("toggle-warehouse-selection-mode-btn");
  if (toggleModeBtn) {
    toggleModeBtn.addEventListener("click", toggleWarehouseSelectionMode);
  }

  const closeWarehouseBtn = document.getElementById("close-warehouse-btn");
  if (closeWarehouseBtn) {
    closeWarehouseBtn.addEventListener("click", closeWarehouseModal);
  }

  const deleteWarehouseBtn = document.getElementById("delete-selected-warehouse-btn");
  if (deleteWarehouseBtn) {
    deleteWarehouseBtn.addEventListener("click", deleteSelectedWarehouse);
  }
})();

// -----------------------------------------
// APIã‚­ãƒ¼é–¢é€£
// -----------------------------------------
document.getElementById("set-api-key-button").addEventListener("click", function () {
  const apiKey = document.getElementById("api-key-input").value.trim();
  if (apiKey) {
    localStorage.setItem("apiKey", apiKey);
    showToast("APIã‚­ãƒ¼ãŒè¨­å®šã•ã‚Œã¾ã—ãŸã€‚");
  } else {
    showToast("APIã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
  }
});

document.getElementById("clear-api-key-button").addEventListener("click", function () {
  const confirmClear = confirm("APIã‚­ãƒ¼ã‚’ã‚¯ãƒªã‚¢ã™ã‚‹ã¨æ“ä½œãŒã§ããªããªã‚Šã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ");
  if (confirmClear) {
    localStorage.removeItem("apiKey");
    showToast("APIã‚­ãƒ¼ãŒã‚¯ãƒªã‚¢ã•ã‚Œã¾ã—ãŸã€‚");
  }
});

// -----------------------------------------
// å…¨ã‚¨ãƒ¬ãƒ¡ãƒ³ãƒˆã‚’ã‚¯ãƒªã‚¢
// -----------------------------------------
document.getElementById("clear-character-btn").addEventListener("click", async () => {
  const confirmClear = confirm("ã‚¨ãƒ¬ãƒ¡ãƒ³ãƒˆæƒ…å ±ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ");
  if (confirmClear) {
    window.characterData = [];
    await saveCharacterDataToIndexedDB(window.characterData);
    showToast("ã‚¨ãƒ¬ãƒ¡ãƒ³ãƒˆæƒ…å ±ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸã€‚");
  }
});

// -----------------------------------------
// ã‚·ãƒŠãƒªã‚ªå‰Šé™¤ç”¨ãƒ¢ãƒ¼ãƒ€ãƒ«ã®åˆ¶å¾¡
// -----------------------------------------
function showDeleteScenarioModal(show) {
  const modal = document.getElementById("delete-scenario-modal");
  if (!modal) return;
  modal.style.display = show ? "flex" : "none";
}

document.getElementById("delete-scenario-ok").addEventListener("click", async () => {
  if (scenarioIdToDelete == null) {
    showDeleteScenarioModal(false);
    return;
  }
  try {
    await deleteScenarioById(scenarioIdToDelete);  // indexedDB.js ã®é–¢æ•°
    showToast(`ã‚·ãƒŠãƒªã‚ª(ID:${scenarioIdToDelete})ã‚’å‰Šé™¤ã—ã¾ã—ãŸã€‚`);
  } catch (err) {
    console.error(err);
    showToast("ã‚·ãƒŠãƒªã‚ªå‰Šé™¤ã«å¤±æ•—:\n" + err.message);
  }
  scenarioIdToDelete = null;
  showDeleteScenarioModal(false);

  // ä¸€è¦§ã‚’å†æç”»ã™ã‚‹ãŸã‚ãƒªãƒ­ãƒ¼ãƒ‰
  location.reload();
});

document.getElementById("delete-scenario-cancel").addEventListener("click", () => {
  scenarioIdToDelete = null;
  showDeleteScenarioModal(false);
});

// -----------------------------------------
// ãƒ‡ãƒ¢ç”¨ãƒœã‚¿ãƒ³
// -----------------------------------------
document.getElementById("sample-btn").addEventListener("click", () => {
  showToast("ã»ã’");
});

// -----------------------------------------
// â–¼ å€‰åº«è¡¨ç¤ºé–¢é€£ (æ–°è¦æ©Ÿèƒ½)
// -----------------------------------------

/** å€‰åº«ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º */
function showWarehouseModal() {
  const modal = document.getElementById("warehouse-modal");
  modal.style.display = "flex";
  renderWarehouseCards();
}

/** å€‰åº«ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹ */
function closeWarehouseModal() {
  const modal = document.getElementById("warehouse-modal");
  modal.style.display = "none";

  // é¸æŠãƒ¢ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆ
  warehouseSelectionMode = false;
  document.getElementById("toggle-warehouse-selection-mode-btn").textContent = "é¸æŠãƒ¢ãƒ¼ãƒ‰";
  document.getElementById("delete-selected-warehouse-btn").style.display = "none";

  // é¸æŠçŠ¶æ…‹ã‚’è§£é™¤
  const selectedCards = document.querySelectorAll("#warehouse-card-container .card.selected");
  selectedCards.forEach(card => card.classList.remove("selected"));
}

/** å€‰åº«å†…ã‚«ãƒ¼ãƒ‰ã‚’å†æç”» */
function renderWarehouseCards() {
  const container = document.getElementById("warehouse-card-container");
  container.innerHTML = "";

  // group==="Warehouse" ã®ã‚«ãƒ¼ãƒ‰ã‚’æŠ½å‡º
  const warehouseCards = window.characterData.filter(c => c.group === "Warehouse");
  if (warehouseCards.length === 0) {
    container.textContent = "å€‰åº«ã«ã‚«ãƒ¼ãƒ‰ãŒã‚ã‚Šã¾ã›ã‚“ã€‚";
    return;
  }

  // ã‚«ãƒ¼ãƒ‰è¦ç´ ç”Ÿæˆ
  warehouseCards.forEach(card => {
    const cardEl = createWarehouseCardElement(card);
    container.appendChild(cardEl);
  });
}

/** å€‰åº«ã‚«ãƒ¼ãƒ‰DOMç”Ÿæˆ */
function createWarehouseCardElement(card) {
  const cardEl = document.createElement("div");
  cardEl.className = "card";
  cardEl.setAttribute("data-id", card.id);

  // ã‚«ãƒ¼ãƒ‰ã‚¯ãƒªãƒƒã‚¯æ™‚
  cardEl.addEventListener("click", (e) => {
    if (warehouseSelectionMode) {
      e.stopPropagation();
      cardEl.classList.toggle("selected");
      updateDeleteSelectedWarehouseButton();
    } else {
      // é€šå¸¸ã¯åè»¢è¡¨ç¤º
      cardEl.classList.toggle("flipped");
    }
  });

  // ã‚«ãƒ¼ãƒ‰å†…éƒ¨æ§‹é€ 
  const cardInner = document.createElement("div");
  cardInner.className = "card-inner";

  const cardFront = document.createElement("div");
  cardFront.className = "card-front";

  // èƒŒæ™¯CSS
  const bgStyle = (card.backgroundcss || "")
    .replace("background-image:", "")
    .replace("background", "")
    .trim();
  cardFront.style = "background-image:" + bgStyle;

  // ãƒ¬ã‚¢ãƒªãƒ†ã‚£ã«å¯¾å¿œã™ã‚‹æ 
  const rarityValue = (typeof card.rarity === "string") ? card.rarity.replace("â˜…", "").trim() : "0";
  cardFront.innerHTML = `<div class='bezel rarity${rarityValue}'></div>`;

  // ã‚«ãƒ¼ãƒ‰ã‚¿ã‚¤ãƒ—è¡¨ç¤º
  const typeEl = document.createElement("div");
  typeEl.className = "card-type";
  typeEl.textContent = card.type || "ä¸æ˜";
  cardFront.appendChild(typeEl);

  // ç”»åƒéƒ¨
  const imageContainer = document.createElement("div");
  imageContainer.className = "card-image";
  if (card.imageData) {
    const imageEl = document.createElement("img");
    imageEl.src = card.imageData;
    imageEl.alt = card.name;
    imageContainer.appendChild(imageEl);
  }
  cardFront.appendChild(imageContainer);

  // ä¸‹éƒ¨æƒ…å ±
  const infoContainer = document.createElement("div");
  infoContainer.className = "card-info";

  // åå‰
  const nameEl = document.createElement("p");
  nameEl.innerHTML = "<h3>" + DOMPurify.sanitize(card.name) + "</h3>";
  infoContainer.appendChild(nameEl);

  // çŠ¶æ…‹
  if (card.state) {
    const stateEl = document.createElement("p");
    stateEl.innerHTML = "<strong>çŠ¶æ…‹ï¼š</strong>" + DOMPurify.sanitize(card.state);
    infoContainer.appendChild(stateEl);
  }

  // ç‰¹æŠ€
  const specialEl = document.createElement("p");
  specialEl.innerHTML = "<strong>ç‰¹æŠ€ï¼š</strong>" + DOMPurify.sanitize(card.special);
  infoContainer.appendChild(specialEl);

  // ã‚­ãƒ£ãƒ—ã‚·ãƒ§ãƒ³
  const captionEl = document.createElement("p");
  captionEl.innerHTML = "<span>" + DOMPurify.sanitize(card.caption) + "</span>";
  infoContainer.appendChild(captionEl);

  cardFront.appendChild(infoContainer);

  const cardBack = document.createElement("div");
  cardBack.className = "card-back";
  cardBack.innerHTML = `<strong>${DOMPurify.sanitize(card.type)}</strong>`;

  cardInner.appendChild(cardFront);
  cardInner.appendChild(cardBack);
  cardEl.appendChild(cardInner);

  return cardEl;
}

/** å€‰åº«ã®é¸æŠãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆ */
function toggleWarehouseSelectionMode() {
  warehouseSelectionMode = !warehouseSelectionMode;
  const btn = document.getElementById("toggle-warehouse-selection-mode-btn");
  if (warehouseSelectionMode) {
    btn.textContent = "é¸æŠãƒ¢ãƒ¼ãƒ‰è§£é™¤";
  } else {
    btn.textContent = "é¸æŠãƒ¢ãƒ¼ãƒ‰";
    // ãƒ¢ãƒ¼ãƒ‰è§£é™¤æ™‚ã¯ã™ã¹ã¦é¸æŠè§£é™¤
    const selectedCards = document.querySelectorAll("#warehouse-card-container .card.selected");
    selectedCards.forEach(card => card.classList.remove("selected"));
  }
  updateDeleteSelectedWarehouseButton();
}

/** é¸æŠçŠ¶æ…‹ã«å¿œã˜ã¦ã€Œé¸æŠã—ãŸã‚«ãƒ¼ãƒ‰ã‚’å‰Šé™¤ã€ãƒœã‚¿ãƒ³ã®è¡¨ç¤ºã‚’åˆ‡ã‚Šæ›¿ãˆ */
function updateDeleteSelectedWarehouseButton() {
  const deleteBtn = document.getElementById("delete-selected-warehouse-btn");
  if (!warehouseSelectionMode) {
    deleteBtn.style.display = "none";
    return;
  }
  const selected = document.querySelectorAll("#warehouse-card-container .card.selected");
  deleteBtn.style.display = (selected.length > 0) ? "inline-block" : "none";
}

/** é¸æŠã—ãŸå€‰åº«å†…ã‚«ãƒ¼ãƒ‰ã‚’å‰Šé™¤ */
async function deleteSelectedWarehouse() {
  const selectedCards = document.querySelectorAll("#warehouse-card-container .card.selected");
  if (selectedCards.length === 0) {
    alert("ã‚«ãƒ¼ãƒ‰ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚");
    return;
  }

  // é¸æŠã‚«ãƒ¼ãƒ‰ã‚’characterDataã‹ã‚‰å‰Šé™¤
  selectedCards.forEach(cardEl => {
    const cardId = cardEl.getAttribute("data-id");
    const idx = window.characterData.findIndex(c => c.id === cardId);
    if (idx !== -1) {
      // ã“ã“ã§ã¯ã€Œå€‰åº«ã‹ã‚‰å–ã‚Šé™¤ãã€ã§ã¯ãªãã€Œå®Œå…¨ã«å‰Šé™¤ã€ã™ã‚‹æŒ™å‹•
      window.characterData.splice(idx, 1);
    }
  });

  await saveCharacterDataToIndexedDB(window.characterData);

  // å†æç”»
  renderWarehouseCards();
  updateDeleteSelectedWarehouseButton();
}
--- 
partyCreate.js 
// partyCreate.js

// ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
window.partySelectionMode = false;    // ãƒ‘ãƒ¼ãƒ†ã‚£å´ã®é¸æŠãƒ¢ãƒ¼ãƒ‰ãƒ•ãƒ©ã‚°
window.warehouseSelectionMode = false; // å€‰åº«å´ã®é¸æŠãƒ¢ãƒ¼ãƒ‰ãƒ•ãƒ©ã‚°

window.addEventListener("load", async function(){
    await initIndexedDB();
    const stored = await loadCharacterDataFromIndexedDB();
    if(stored) {
      window.characterData = stored;
    } else {
      window.characterData = [];
    }

    // ãƒ‘ãƒ¼ãƒ†ã‚£è¡¨ç¤º
    renderParty();

    // å€‰åº«ãƒ¢ãƒ¼ãƒ€ãƒ«ç®¡ç†
    document.getElementById("show-warehouse-btn").addEventListener("click", () => {
      showWarehouseModal();
    });

    // å€‰åº«ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
    document.getElementById("close-warehouse-btn").addEventListener("click", () => {
      document.getElementById("warehouse-modal").style.display = "none";
      // å€‰åº«å´ã®é¸æŠã‚’ãƒªã‚»ãƒƒãƒˆ
      warehouseSelectionMode = false;
      document.getElementById("toggle-warehouse-selection-mode-btn").textContent = "é¸æŠãƒ¢ãƒ¼ãƒ‰";
      document.getElementById("add-to-party-btn").style.display = "none";
      // å…¨ã‚«ãƒ¼ãƒ‰ã® selected ã‚’å¤–ã™
      const selectedCards = document.querySelectorAll("#warehouse-card-container .card.selected");
      selectedCards.forEach(el => el.classList.remove("selected"));
    });

    // ã€Œé¸æŠãƒ¢ãƒ¼ãƒ‰ï¼ˆãƒ‘ãƒ¼ãƒ†ã‚£å´ï¼‰ã€ãƒœã‚¿ãƒ³
    document.getElementById("toggle-party-selection-mode-btn").addEventListener("click", () => {
      window.partySelectionMode = !window.partySelectionMode;
      const btn = document.getElementById("toggle-party-selection-mode-btn");
      if(partySelectionMode) {
        btn.textContent = "é¸æŠãƒ¢ãƒ¼ãƒ‰è§£é™¤";
      } else {
        btn.textContent = "é¸æŠãƒ¢ãƒ¼ãƒ‰";
        // è§£é™¤æ™‚ã€é¸æŠã‚’å…¨ãƒªã‚»ãƒƒãƒˆ
        const selectedCards = document.querySelectorAll("#party-card-container .card.selected");
        selectedCards.forEach(el => el.classList.remove("selected"));
      }
      updatePartyMoveButtonVisibility();
    });

    // ã€Œãƒ‘ãƒ¼ãƒ†ã‚£é¸æŠã‚«ãƒ¼ãƒ‰ã‚’å€‰åº«ã«æˆ»ã™ã€ãƒœã‚¿ãƒ³
    document.getElementById("move-selected-to-warehouse-btn").addEventListener("click", async () => {
      const selectedCards = document.querySelectorAll("#party-card-container .card.selected");
      if(selectedCards.length === 0) {
        alert("ã‚«ãƒ¼ãƒ‰ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚");
        return;
      }
      selectedCards.forEach(el => {
        const cardId = el.getAttribute("data-id");
        const idx = window.characterData.findIndex(c => c.id === cardId);
        if(idx !== -1) {
          window.characterData[idx].group = "Warehouse";
        }
      });
      await saveCharacterDataToIndexedDB(window.characterData);
      // é¸æŠè§£é™¤ & å†æç”»
      selectedCards.forEach(el => el.classList.remove("selected"));
      renderParty();
      updatePartyMoveButtonVisibility();
    });

    // ã€Œé¸æŠãƒ¢ãƒ¼ãƒ‰ï¼ˆå€‰åº«å´ï¼‰ã€ãƒœã‚¿ãƒ³
    document.getElementById("toggle-warehouse-selection-mode-btn").addEventListener("click", () => {
      window.warehouseSelectionMode = !window.warehouseSelectionMode;
      const btn = document.getElementById("toggle-warehouse-selection-mode-btn");
      if(warehouseSelectionMode) {
        btn.textContent = "é¸æŠãƒ¢ãƒ¼ãƒ‰è§£é™¤";
      } else {
        btn.textContent = "é¸æŠãƒ¢ãƒ¼ãƒ‰";
        // è§£é™¤æ™‚ã€é¸æŠã‚’å…¨ãƒªã‚»ãƒƒãƒˆ
        const selectedCards = document.querySelectorAll("#warehouse-card-container .card.selected");
        selectedCards.forEach(el => el.classList.remove("selected"));
      }
      updateWarehouseAddButtonVisibility();
    });

    // ã€Œå€‰åº«é¸æŠã‚«ãƒ¼ãƒ‰ã‚’ãƒ‘ãƒ¼ãƒ†ã‚£ã¸ã€ãƒœã‚¿ãƒ³
    document.getElementById("add-to-party-btn").addEventListener("click", async () => {
      const selectedCards = document.querySelectorAll("#warehouse-card-container .card.selected");
      if(selectedCards.length === 0) {
        alert("ã‚«ãƒ¼ãƒ‰ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚");
        return;
      }
      selectedCards.forEach(el => {
        const cardId = el.getAttribute("data-id");
        const realIndex = window.characterData.findIndex(c => c.id === cardId);
        if(realIndex !== -1){
          window.characterData[realIndex].group = "Party";
        }
      });

      await saveCharacterDataToIndexedDB(window.characterData);
      // é¸æŠè§£é™¤
      selectedCards.forEach(el => el.classList.remove("selected"));
      // å€‰åº«å†æç”» & ãƒ‘ãƒ¼ãƒ†ã‚£å†æç”»
      showWarehouseModal();
      renderParty();
      updateWarehouseAddButtonVisibility();
    });

    // æˆ»ã‚‹ãƒœã‚¿ãƒ³
    document.getElementById("back-to-menu").addEventListener("click", () => {
      window.location.href = "index.html";
    });
});


/** ãƒ‘ãƒ¼ãƒ†ã‚£ã®ã‚«ãƒ¼ãƒ‰ã‚’è¡¨ç¤º */
function renderParty(){
  const partyContainer = document.getElementById("party-card-container");
  partyContainer.innerHTML = "";
  // group==="Party" ã®ã¿æŠ½å‡º
  const partyCards = window.characterData.filter(c => c.group === "Party");

  if(partyCards.length === 0){
    partyContainer.textContent = "ãƒ‘ãƒ¼ãƒ†ã‚£ã«ã‚«ãƒ¼ãƒ‰ãŒã‚ã‚Šã¾ã›ã‚“ã€‚";
    return;
  }

  partyCards.forEach((card) => {
    const cardEl = createPartyCardElement(card);
    partyContainer.appendChild(cardEl);
  });
}

/** ãƒ‘ãƒ¼ãƒ†ã‚£ã‚«ãƒ¼ãƒ‰ç”Ÿæˆ */
function createPartyCardElement(card){
  const cardEl = document.createElement("div");
  cardEl.className = "card";
  cardEl.setAttribute("data-id", card.id);

  // ã‚¯ãƒªãƒƒã‚¯æ™‚ã®å‹•ä½œ
  cardEl.addEventListener("click", (e) => {
    if(window.partySelectionMode) {
      e.stopPropagation();
      cardEl.classList.toggle("selected");
      updatePartyMoveButtonVisibility();
    } else {
      // é€šå¸¸æ™‚ã¯ã‚«ãƒ¼ãƒ‰ã‚’åè»¢
      cardEl.classList.toggle("flipped");
    }
  });

  const cardInner = document.createElement("div");
  cardInner.className = "card-inner";

  const cardFront = document.createElement("div");
  cardFront.className = "card-front";

  const bgStyle = card.backgroundcss
      .replace("background-image:", "")
      .replace("background", "")
      .trim();
  cardFront.style = "background-image:" + bgStyle;

  const rarityValue = (typeof card.rarity === "string") ? card.rarity.replace("â˜…", "").trim() : "0";
  cardFront.innerHTML = `<div class='bezel rarity${rarityValue}'></div>`;

  const typeEl = document.createElement("div");
  typeEl.className = "card-type";
  typeEl.textContent = card.type || "ä¸æ˜";
  cardFront.appendChild(typeEl);

  const imageContainer = document.createElement("div");
  imageContainer.className = "card-image";
  if(card.imageData){
    const imageEl = document.createElement("img");
    imageEl.src = card.imageData;
    imageEl.alt = card.name;
    imageContainer.appendChild(imageEl);
  }
  cardFront.appendChild(imageContainer);

  const infoContainer = document.createElement("div");
  infoContainer.className = "card-info";

  const nameEl = document.createElement("p");
  nameEl.innerHTML = "<h3>" + DOMPurify.sanitize(card.name) + "</h3>";
  infoContainer.appendChild(nameEl);

  if (card.state) {
    const stateEl = document.createElement("p");
    stateEl.innerHTML = "<strong>çŠ¶æ…‹ï¼š</strong>" + DOMPurify.sanitize(card.state);
    infoContainer.appendChild(stateEl);
  }
  const specialEl = document.createElement("p");
  specialEl.innerHTML = "<strong>ç‰¹æŠ€ï¼š</strong>" + DOMPurify.sanitize(card.special);
  infoContainer.appendChild(specialEl);

  const captionEl = document.createElement("p");
  captionEl.innerHTML = "<span>" + DOMPurify.sanitize(card.caption) + "</span>";
  infoContainer.appendChild(captionEl);

  cardFront.appendChild(infoContainer);

  const cardBack = document.createElement("div");
  cardBack.className = "card-back";
  cardBack.innerHTML = `<strong>${DOMPurify.sanitize(card.type)}</strong>`;

  cardInner.appendChild(cardFront);
  cardInner.appendChild(cardBack);
  cardEl.appendChild(cardInner);

  return cardEl;
}

/** å€‰åº«ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º */
function showWarehouseModal(){
  const modal = document.getElementById("warehouse-modal");
  modal.style.display = "flex";

  const warehouseContainer = document.getElementById("warehouse-card-container");
  warehouseContainer.innerHTML = "";

  // group==="Warehouse" ã®ã¿
  const warehouseCards = window.characterData.filter(c => c.group === "Warehouse");
  if(warehouseCards.length === 0) {
    warehouseContainer.textContent = "å€‰åº«ã«ã‚«ãƒ¼ãƒ‰ãŒã‚ã‚Šã¾ã›ã‚“ã€‚";
    return;
  }

  warehouseCards.forEach((card) => {
    const cardEl = createWarehouseCardElement(card);
    warehouseContainer.appendChild(cardEl);
  });
  updateWarehouseAddButtonVisibility();
}

/** å€‰åº«ã‚«ãƒ¼ãƒ‰ç”Ÿæˆ */
function createWarehouseCardElement(card){
  const cardEl = document.createElement("div");
  cardEl.className = "card";
  cardEl.setAttribute("data-id", card.id);

  // ã‚¯ãƒªãƒƒã‚¯æ™‚
  cardEl.addEventListener("click", (e) => {
    if(window.warehouseSelectionMode) {
      e.stopPropagation();
      cardEl.classList.toggle("selected");
      updateWarehouseAddButtonVisibility();
    } else {
      cardEl.classList.toggle("flipped");
    }
  });

  const cardInner = document.createElement("div");
  cardInner.className = "card-inner";

  const cardFront = document.createElement("div");
  cardFront.className = "card-front";
  const bgStyle = card.backgroundcss
      .replace("background-image:", "")
      .replace("background", "")
      .trim();
  cardFront.style = "background-image:" + bgStyle;

  const rarityValue = (typeof card.rarity === "string") ? card.rarity.replace("â˜…", "").trim() : "0";
  cardFront.innerHTML = `<div class='bezel rarity${rarityValue}'></div>`;

  const typeEl = document.createElement("div");
  typeEl.className = "card-type";
  typeEl.textContent = card.type || "ä¸æ˜";
  cardFront.appendChild(typeEl);

  const imageContainer = document.createElement("div");
  imageContainer.className = "card-image";
  if(card.imageData){
    const imageEl = document.createElement("img");
    imageEl.src = card.imageData;
    imageEl.alt = card.name;
    imageContainer.appendChild(imageEl);
  }
  cardFront.appendChild(imageContainer);

  const infoContainer = document.createElement("div");
  infoContainer.className = "card-info";

  const nameEl = document.createElement("p");
  nameEl.innerHTML = "<h3>" + DOMPurify.sanitize(card.name) + "</h3>";
  infoContainer.appendChild(nameEl);

  if (card.state) {
    const stateEl = document.createElement("p");
    stateEl.innerHTML = "<strong>çŠ¶æ…‹ï¼š</strong>" + DOMPurify.sanitize(card.state);
    infoContainer.appendChild(stateEl);
  }
  const specialEl = document.createElement("p");
  specialEl.innerHTML = "<strong>ç‰¹æŠ€ï¼š</strong>" + DOMPurify.sanitize(card.special);
  infoContainer.appendChild(specialEl);

  const captionEl = document.createElement("p");
  captionEl.innerHTML = "<span>" + DOMPurify.sanitize(card.caption) + "</span>";
  infoContainer.appendChild(captionEl);

  cardFront.appendChild(infoContainer);

  const cardBack = document.createElement("div");
  cardBack.className = "card-back";
  cardBack.innerHTML = `<strong>${DOMPurify.sanitize(card.type)}</strong>`;

  cardInner.appendChild(cardFront);
  cardInner.appendChild(cardBack);
  cardEl.appendChild(cardInner);

  return cardEl;
}

/** ãƒ‘ãƒ¼ãƒ†ã‚£ã¸å…¥ã‚Œã‚‹ãƒœã‚¿ãƒ³ã®è¡¨ç¤ºãƒ»éè¡¨ç¤ºåˆ¶å¾¡ï¼ˆå€‰åº«å´ï¼‰ */
function updateWarehouseAddButtonVisibility(){
  const addBtn = document.getElementById("add-to-party-btn");
  if(!warehouseSelectionMode) {
    // é¸æŠãƒ¢ãƒ¼ãƒ‰OFFæ™‚ã¯éè¡¨ç¤º
    addBtn.style.display = "none";
    return;
  }
  // é¸æŠãƒ¢ãƒ¼ãƒ‰ON
  const selectedCards = document.querySelectorAll("#warehouse-card-container .card.selected");
  if(selectedCards.length > 0){
    addBtn.style.display = "inline-block";
  } else {
    addBtn.style.display = "none";
  }
}

/** å€‰åº«ã«æˆ»ã™ãƒœã‚¿ãƒ³ã®è¡¨ç¤ºãƒ»éè¡¨ç¤ºåˆ¶å¾¡ï¼ˆãƒ‘ãƒ¼ãƒ†ã‚£å´ï¼‰ */
function updatePartyMoveButtonVisibility(){
  const moveBtn = document.getElementById("move-selected-to-warehouse-btn");
  if(!partySelectionMode){
    moveBtn.style.display = "none";
    return;
  }
  const selectedCards = document.querySelectorAll("#party-card-container .card.selected");
  if(selectedCards.length > 0) {
    moveBtn.style.display = "inline-block";
  } else {
    moveBtn.style.display = "none";
  }
}
--- 
scenarioPage.js 
/********************************
 * scenarioPage.js
 * ã‚·ãƒŠãƒªã‚ªãƒšãƒ¼ã‚¸å›ºæœ‰ã®UIæ“ä½œ
 * - ã€Œå›ç­”å€™è£œã‚’ç”Ÿæˆã€æ©Ÿèƒ½
 * - ã€Œã‚«ãƒ¼ãƒ‰ã‚’å–å¾—ã™ã‚‹ã€ãƒœã‚¿ãƒ³ã§ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
 ********************************/

window.addEventListener("load", async () => {
  // 1. IndexedDB åˆæœŸåŒ–
  await initIndexedDB();

  // 2. ã‚‚ã—window.characterDataãŒç„¡ã‘ã‚Œã°ç©ºé…åˆ—ã‚’ç”¨æ„
  if (!window.characterData) {
    window.characterData = [];
  }

  // 3. IndexedDBã‹ã‚‰ã‚­ãƒ£ãƒ©ã‚¯ã‚¿é…åˆ—ã‚’ãƒ­ãƒ¼ãƒ‰ã—ã€ä¸Šæ›¸ã
  const stored = await loadCharacterDataFromIndexedDB();
  if (stored && stored.length > 0) {
    window.characterData = stored;
  }

  console.log(
    "scenarioPage.js: IndexedDB init & characterData loaded. length=",
    window.characterData.length
  );

  // ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«æˆ»ã‚‹ãƒœã‚¿ãƒ³ï¼ˆã‚·ãƒŠãƒªã‚ªç”»é¢ â†’ index.htmlï¼‰
  const backToMenuBtn = document.getElementById("back-to-menu");
  if (backToMenuBtn) {
    backToMenuBtn.addEventListener("click", () => {
      window.location.href = "index.html";
    });
  }

  // ãƒã‚¿ãƒãƒ¬ï¼ˆç›®çš„é”æˆå‹ï¼‰
  const spoilerModal = document.getElementById("spoiler-modal");
  const spoilerButton = document.getElementById("spoiler-button");
  const closeSpoilerModalBtn = document.getElementById("close-spoiler-modal");
  if (spoilerButton) {
    spoilerButton.addEventListener("click", () => {
      spoilerModal.style.display = "flex";
    });
  }
  if (closeSpoilerModalBtn) {
    closeSpoilerModalBtn.addEventListener("click", () => {
      spoilerModal.style.display = "none";
    });
  }

  // -----------------------------
  // ã€Œã‚«ãƒ¼ãƒ‰ã‚’å–å¾—ã™ã‚‹ã€ãƒœã‚¿ãƒ³æŠ¼ä¸‹ â†’ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ¢ãƒ¼ãƒ€ãƒ«
  // -----------------------------
  const getCardButton = document.getElementById("get-card-button");
  if (getCardButton) {
    getCardButton.addEventListener("click", async () => {
      // 1) æœ€æ–°ã‚·ãƒ¼ãƒ³ã‹ã‚‰ã‚«ãƒ¼ãƒ‰åŒ–ã«ä½¿ãˆãã†ãªæƒ…å ±ã‚’è¦ç´„
      const sceneSummary = await getLastSceneSummary();

      // ã‚·ãƒ¼ãƒ³è¦ç´„ä¸­ã‹ã‚‰ã€åå‰ã€‘ã‚„ã€ã‚¿ã‚¤ãƒ—ã€‘ã€å¤–è¦‹ã€‘ç­‰ã‚’æŠœãå‡ºã™ï¼ˆã‚µãƒ³ãƒ—ãƒ«å®Ÿè£…ï¼‰
      const lines = sceneSummary.split("\n");
      let onlyTitle = "", onlyType = "", addPrompt = "";
      lines.forEach((line) => {
        const trimLine = line.trim();
        if (trimLine.startsWith("ã€åå‰ã€‘")) {
          onlyTitle = trimLine.replace("ã€åå‰ã€‘", "").replace("ï¼š", "").trim();
        } else if (trimLine.startsWith("ã€ã‚¿ã‚¤ãƒ—ã€‘")) {
          onlyType = trimLine.replace("ã€ã‚¿ã‚¤ãƒ—ã€‘", "").replace("ï¼š", "").trim();
        } else if (trimLine.startsWith("ã€å¤–è¦‹ã€‘")) {
          addPrompt = trimLine.replace("ã€å¤–è¦‹ã€‘", "").replace("ï¼š", "").trim();
        }
      });

      // 2) ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤ºï¼ˆãƒ†ã‚­ã‚¹ãƒˆã§ã®èª¬æ˜ï¼‰
      const previewModal = document.getElementById("card-preview-modal");
      const previewContainer = document.getElementById("preview-card-container");
      if (!previewModal || !previewContainer) return;

      // ã„ã£ãŸã‚“å†…éƒ¨ã‚’ã‚¯ãƒªã‚¢
      previewContainer.innerHTML = "";

      // ã“ã“ã§ã¯ä»®ã«ã€Œã“ã®ã‚«ãƒ¼ãƒ‰ã®æ¦‚è¦ã€ã‚’ãƒ†ã‚­ã‚¹ãƒˆã§è¡¨ç¤ºã™ã‚‹ã‚µãƒ³ãƒ—ãƒ«
      const preText = document.createElement("p");
      preText.textContent = 
        `ã€åå‰ã€‘ï¼š${onlyTitle || "(æœªå–å¾—)"}\n` +
        `ã€ã‚¿ã‚¤ãƒ—ã€‘ï¼š${onlyType || "(æœªå–å¾—)"}\n` +
        `ã€å¤–è¦‹(ç”Ÿæˆãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ)ã€‘ï¼š${addPrompt || "(æœªå–å¾—)"}\n\n` +
        "ã“ã®å†…å®¹ã§ã‚«ãƒ¼ãƒ‰ã‚’ç”Ÿæˆã—ã¾ã™ã‹ï¼Ÿ"
      ;
      preText.style.whiteSpace = "pre-wrap";
      previewContainer.appendChild(preText);

      // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
      previewModal.style.display = "flex";

      // ã€Œã‚¬ãƒãƒ£ç®±ã«è¿½åŠ ã€ãƒœã‚¿ãƒ³
      const addBtn = document.getElementById("add-to-gachabox-button");
      if (addBtn) {
        addBtn.onclick = async () => {
          previewModal.style.display = "none";
          // å®Ÿéš›ã«ã‚«ãƒ¼ãƒ‰ã‚’ç”Ÿæˆï¼ˆ1æšï¼‰ã—ã¦ã‚¬ãƒãƒ£ç®±ã¸
          const gachaModal = document.getElementById("gacha-modal");
          if (gachaModal) {
            gachaModal.style.display = "flex";
          }
          try {
            await runGacha(1, addPrompt, onlyTitle, onlyType);
            alert("æ–°ã—ã„ã‚«ãƒ¼ãƒ‰ã‚’ã‚¬ãƒãƒ£ç®±ã«è¿½åŠ ã—ã¾ã—ãŸã€‚\nã€Œã‚¨ãƒ¬ãƒ¡ãƒ³ãƒˆä½œæˆã€ç”»é¢ã§ç¢ºèªã§ãã¾ã™ã€‚");
          } catch (err) {
            console.error(err);
            alert("ã‚«ãƒ¼ãƒ‰ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ:\n" + err.message);
          } finally {
            if (gachaModal) {
              gachaModal.style.display = "none";
            }
          }
        };
      }

      // ã€Œã‚­ãƒ£ãƒ³ã‚»ãƒ«ã€ãƒœã‚¿ãƒ³
      const cancelBtn = document.getElementById("cancel-card-preview-button");
      if (cancelBtn) {
        cancelBtn.onclick = () => {
          previewModal.style.display = "none";
        };
      }
    });
  }

  // -----------------------------
  // ã€Œå›ç­”å€™è£œã‚’ç”Ÿæˆã€ãƒœã‚¿ãƒ³
  // -----------------------------
  const generateActionCandidatesBtn = document.getElementById("generate-action-candidates-button");
  if (generateActionCandidatesBtn) {
    generateActionCandidatesBtn.addEventListener("click", onGenerateActionCandidates);
  }
});

/**
 * å›ç­”å€™è£œï¼ˆãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼è¡Œå‹•æ¡ˆï¼‰ã‚’ç”Ÿæˆ
 */
async function onGenerateActionCandidates() {
  if (!window.apiKey) {
    alert("APIã‚­ãƒ¼ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚");
    return;
  }
  // æœ€æ–°ã‚·ãƒ¼ãƒ³ã‚’å–å¾—
  const lastSceneEntry = [...window.sceneHistory].reverse().find(e => e.type === 'scene');
  const lastSceneText = lastSceneEntry ? lastSceneEntry.content : "(ã‚·ãƒ¼ãƒ³ãŒã‚ã‚Šã¾ã›ã‚“)";

  window.cancelRequested = false;
  showLoadingModal(true);

  try {
    window.currentRequestController = new AbortController();
    const signal = window.currentRequestController.signal;

    const prompt = `
      ã‚ãªãŸã¯TRPGã®ã‚²ãƒ¼ãƒ ãƒã‚¹ã‚¿ãƒ¼ã§ã™ã€‚
      æ¬¡ã®ã‚·ãƒ¼ãƒ³ã¯ä¸‹è¨˜ã®æå†™ã§ã™ã€‚
      ---
      ${lastSceneText}
      ---
      ã“ã®çŠ¶æ³ã§ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒå–ã‚Šå¾—ã‚‹è¡Œå‹•æ¡ˆã‚’5ã¤ã»ã©ææ¡ˆã—ã¦ãã ã•ã„ã€‚
      ç®‡æ¡æ›¸ãå½¢å¼ã§çŸ­ã‚ã«ãŠé¡˜ã„ã—ã¾ã™ã€‚
    `;

    const response = await fetch("https://api.openai.com/v1/chat/completions", {
      method:"POST",
      headers:{
        "Content-Type":"application/json",
        "Authorization":`Bearer ${window.apiKey}`
      },
      body: JSON.stringify({
        model: "gpt-4",
        messages: [
          { role:"system", content:"ã‚ãªãŸã¯å„ªç§€ãªTRPGã®ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã§ã™ã€‚"},
          { role:"user", content: prompt }
        ],
        temperature:0.7
      }),
      signal
    });

    const data = await response.json();
    if(data.error){
      throw new Error(data.error.message);
    }

    const content = data.choices[0].message.content.trim();
    // ã€Œ1. ï½ã€ã®ã‚ˆã†ãªå½¢å¼ã§æ¥ã‚‹ã®ã§è¡Œã”ã¨ã«ãƒœã‚¿ãƒ³ç”Ÿæˆ
    const lines = content.split("\n").map(l=>l.trim()).filter(l=>l);

    const container = document.getElementById("action-candidates-container");
    if(!container) return;
    container.innerHTML = "";

    lines.forEach(line => {
      const btn = document.createElement("button");
      btn.textContent = line.replace(/^\d+\.\s*/, "");  // è¡Œé ­ã® "1. "ãªã©ã‚’å‰Šé™¤
      btn.style.display = "block";
      btn.style.margin = "5px 0";

      // ã‚¯ãƒªãƒƒã‚¯ã§ #player-input ã«åæ˜ 
      btn.addEventListener("click", ()=>{
        const playerInput = document.getElementById("player-input");
        if(playerInput){
          playerInput.value = btn.textContent;
        }
      });

      container.appendChild(btn);
    });

  } catch(err){
    if(err.name === "AbortError"){
      console.log("å›ç­”å€™è£œç”Ÿæˆã‚­ãƒ£ãƒ³ã‚»ãƒ«");
    } else {
      console.error(err);
      alert("å›ç­”å€™è£œã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ:\n" + err.message);
    }
  } finally {
    showLoadingModal(false);
  }
}

/**
 * æœ€æ–°ã‚·ãƒ¼ãƒ³ã®å†…å®¹ã‚’ ChatGPT ã§è¦ç´„ã—ã€ã‚«ãƒ¼ãƒ‰ç”¨ã®ã€åå‰ã€‘ã€ã‚¿ã‚¤ãƒ—ã€‘ã€å¤–è¦‹ã€‘ã‚’æŠ½å‡ºã™ã‚‹ã€‚
 */
async function getLastSceneSummary() {
  const lastSceneEntry = [...window.sceneHistory].reverse().find(e => e.type === "scene");
  if (!lastSceneEntry) return "ã‚·ãƒ¼ãƒ³ãŒã‚ã‚Šã¾ã›ã‚“ã€‚";

  const fullText = lastSceneEntry.content;

  const systemPrompt = `ã‚ãªãŸã¯å„ªç§€ãªã‚«ãƒ¼ãƒ‰ä½œæˆç”¨ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆè£½é€ è€…ã§ã™ã€‚ä»¥ä¸‹ã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã§ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’è£½é€ ã—ã¦ãã ã•ã„ã€‚
ã€åå‰ã€‘ï¼š...
ã€ã‚¿ã‚¤ãƒ—ã€‘ï¼šã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã€ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼ã€ã‚¢ã‚¤ãƒ†ãƒ ã®ã„ãšã‚Œã‹
ã€å¤–è¦‹ã€‘ï¼š...
`;
  const userPrompt = `
ä»¥ä¸‹ã®ã‚·ãƒŠãƒªã‚ªã®1ã‚·ãƒ¼ãƒ³ã‹ã‚‰ã€ã‚¨ãƒ¬ãƒ¡ãƒ³ãƒˆã«ã§ããã†ãªå¯¾è±¡ã‚’1ã¤ã ã‘å–ã‚Šå‡ºã—ã€
ã‚«ãƒ¼ãƒ‰ç”¨ã®ã€åå‰ã€‘ã€ã‚¿ã‚¤ãƒ—ã€‘ã€å¤–è¦‹ã€‘ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚
---
${fullText}
---
`;

  try {
    const response = await fetch("https://api.openai.com/v1/chat/completions", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "Authorization": `Bearer ${window.apiKey}`
      },
      body: JSON.stringify({
        model: "gpt-4",
        messages: [
          { role: "system", content: systemPrompt },
          { role: "user", content: userPrompt }
        ]
      }),
    });

    const data = await response.json();
    if (data.error) throw new Error(data.error.message);

    return data.choices[0].message.content.trim();
  } catch (err) {
    console.error("è¦ç´„å–å¾—å¤±æ•—:", err);
    return "(è¦ç´„å¤±æ•—)";
  }
}

/** ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ãƒ¢ãƒ¼ãƒ€ãƒ«ã®è¡¨ç¤º/éè¡¨ç¤º */
function showLoadingModal(show){
  const modal = document.getElementById("loading-modal");
  if(!modal) return;
  modal.style.display = show ? "flex" : "none";
}

/** ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ä¸­æ–­ */
function onCancelFetch(){
  if(window.currentRequestController){
    window.currentRequestController.abort();
  }
  showLoadingModal(false);
}
--- 
scenarioWizard.js 
/********************************
 * scenarioWizard.js
 * æ–°ã—ã„ã‚·ãƒŠãƒªã‚ªä½œæˆã‚¦ã‚£ã‚¶ãƒ¼ãƒ‰ (è¤‡æ•°ã‚·ãƒŠãƒªã‚ªå¯¾å¿œ)
 ********************************/

let wizardData = {
  genre: "",
  scenarioType: "",      // "objective" or "exploration"
  clearCondition: "",    // ç›®çš„é”æˆå‹ãªã‚‰ChatGPTã‹ã‚‰å–å¾—
  scenarioSummary: ""    // å…¨ä½“ã®ã‚·ãƒŠãƒªã‚ªè¦ç´„
};

window.addEventListener("load", async function () {
  await initIndexedDB();
  loadWizardDataFromLocalStorage();

  // ã‚¤ãƒ™ãƒ³ãƒˆè¨­å®š
  document.getElementById("generate-genre-button").addEventListener("click", onGenerateGenre);
  document.getElementById("clear-genre-button").addEventListener("click", onClearGenre);
  document.getElementById("confirm-genre-button").addEventListener("click", onConfirmGenre);

  document.getElementById("type-objective-btn").addEventListener("click", () => onSelectScenarioType("objective"));
  document.getElementById("type-exploration-btn").addEventListener("click", () => onSelectScenarioType("exploration"));

  document.getElementById("back-to-step1-button").addEventListener("click", onBackToStep1);
  document.getElementById("back-to-step2-button").addEventListener("click", onBackToStep2FromStep3);

  document.getElementById("start-scenario-button").addEventListener("click", onStartScenario);
  document.getElementById("cancel-request-button").addEventListener("click", onCancelFetch);

  // ãƒ¢ãƒ¼ãƒ€ãƒ«ã®OK/Cancel
  document.getElementById("confirm-scenario-ok").addEventListener("click", onConfirmScenarioModalOK);
  document.getElementById("confirm-scenario-cancel").addEventListener("click", onConfirmScenarioModalCancel);

  updateSelectedGenreDisplay();
});

/* ---- ã‚¹ãƒ†ãƒƒãƒ—1 ---- */
async function onGenerateGenre() {
  const genreListDiv = document.getElementById("genre-list");
  const apiKey = localStorage.getItem("apiKey") || "";
  if (!apiKey) {
    alert("APIã‚­ãƒ¼ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚");
    return;
  }

  showLoadingModal(true);
  window.currentRequestController = new AbortController();
  const signal = window.currentRequestController.signal;

  try {
    const messages = [
      { role: "system", content: "ã‚ãªãŸã¯TRPGã®ãƒ—ãƒ­ã§ã™ã€‚ã‚¸ãƒ£ãƒ³ãƒ«ã‚’5ã¤ææ¡ˆã—ã¦ãã ã•ã„ã€‚" },
      { role: "user", content: "SF, ä¸­ä¸–ãƒ•ã‚¡ãƒ³ã‚¿ã‚¸ãƒ¼, ç¾ä»£ãªã©ã€TRPGã«ä½¿ã„ã‚„ã™ã„ã‚¸ãƒ£ãƒ³ãƒ«å€™è£œã‚’5ã¤ã€ç®‡æ¡æ›¸ãã§å‡ºã—ã¦ãã ã•ã„ã€‚" }
    ];
    const response = await fetch("https://api.openai.com/v1/chat/completions", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "Authorization": `Bearer ${apiKey}`
      },
      body: JSON.stringify({
        model: "gpt-4",
        messages: messages,
        temperature: 0.7
      }),
      signal
    });

    const data = await response.json();
    if (data.error) throw new Error(data.error.message);

    const content = data.choices[0].message.content;
    const lines = content.split("\n").map(l => l.trim()).filter(l => l);

    // appendã§ãƒœã‚¿ãƒ³ã‚’è¿½åŠ 
    lines.forEach(line => {
      const btn = document.createElement("button");
      btn.classList.add("candidate-button");
      btn.textContent = line.replace(/^\d+\.\s*/, "");
      btn.style.display = "block";
      btn.style.margin = "5px 0";

      btn.addEventListener("click", () => {
        wizardData.genre = btn.textContent;
        saveWizardDataToLocalStorage();
        highlightSelectedButton(genreListDiv, btn);
        // ã‚¹ãƒ†ãƒƒãƒ—1â†’ã‚¹ãƒ†ãƒƒãƒ—2
        document.getElementById("wizard-step1").style.display = "none";
        document.getElementById("wizard-step2").style.display = "block";
        updateSelectedGenreDisplay();
      });
      genreListDiv.appendChild(btn);
    });
  } catch (err) {
    if (err.name === "AbortError") {
      console.log("ã‚¸ãƒ£ãƒ³ãƒ«ç”Ÿæˆã‚­ãƒ£ãƒ³ã‚»ãƒ«");
    } else {
      console.error(err);
      alert("ã‚¸ãƒ£ãƒ³ãƒ«ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ:\n" + err.message);
    }
  } finally {
    showLoadingModal(false);
  }
}

function onClearGenre() {
  const genreListDiv = document.getElementById("genre-list");
  genreListDiv.innerHTML = "";
  wizardData.genre = "";
  document.getElementById("free-genre-input").value = "";
  saveWizardDataToLocalStorage();
}

function onConfirmGenre() {
  const freeInput = document.getElementById("free-genre-input");
  const txt = (freeInput.value || "").trim();
  if (!txt) {
    alert("ã‚¸ãƒ£ãƒ³ãƒ«ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
    return;
  }
  wizardData.genre = txt;
  saveWizardDataToLocalStorage();

  // ã‚¹ãƒ†ãƒƒãƒ—1â†’ã‚¹ãƒ†ãƒƒãƒ—2
  document.getElementById("wizard-step1").style.display = "none";
  document.getElementById("wizard-step2").style.display = "block";
  updateSelectedGenreDisplay();
}

/* ---- ã‚¹ãƒ†ãƒƒãƒ—2 ---- */

// ã‚·ãƒŠãƒªã‚ªã‚¿ã‚¤ãƒ—é¸æŠæ™‚â†’ã„ããªã‚Šç”Ÿæˆã›ãšã€ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’å‡ºã™
function onSelectScenarioType(type) {
  wizardData.scenarioType = type;
  saveWizardDataToLocalStorage();

  // ãƒ¢ãƒ¼ãƒ€ãƒ«ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’æ›´æ–°
  const textEl = document.getElementById("confirm-genre-type-text");
  textEl.textContent = `ã‚¸ãƒ£ãƒ³ãƒ«: ${wizardData.genre}\nã‚·ãƒŠãƒªã‚ªã‚¿ã‚¤ãƒ—: ${type === "objective" ? "ç›®çš„é”æˆå‹" : "æ¢ç´¢å‹"}`;
  // ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
  const modal = document.getElementById("confirm-scenario-modal");
  modal.style.display = "flex";
}

// ãƒ¢ãƒ¼ãƒ€ãƒ«: OK
async function onConfirmScenarioModalOK() {
  // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
  const modal = document.getElementById("confirm-scenario-modal");
  modal.style.display = "none";

  // ã“ã“ã§ã‚·ãƒŠãƒªã‚ªç”Ÿæˆé–‹å§‹
  if (wizardData.scenarioType === "objective") {
    await generateScenarioSummaryAndClearCondition();
  } else {
    await generateScenarioSummary();
  }

  // ã‚¹ãƒ†ãƒƒãƒ—2â†’ã‚¹ãƒ†ãƒƒãƒ—3
  document.getElementById("wizard-step2").style.display = "none";
  document.getElementById("wizard-step3").style.display = "block";
}

// ãƒ¢ãƒ¼ãƒ€ãƒ«: ã‚­ãƒ£ãƒ³ã‚»ãƒ«
function onConfirmScenarioModalCancel() {
  const modal = document.getElementById("confirm-scenario-modal");
  modal.style.display = "none";
  // ã‚¹ãƒ†ãƒƒãƒ—2ã«ç•™ã¾ã‚‹
}

function onBackToStep1() {
  document.getElementById("wizard-step2").style.display = "none";
  document.getElementById("wizard-step1").style.display = "block";
}

/* ---- ã‚¹ãƒ†ãƒƒãƒ—3 ---- */

// ã€Œã‚¹ãƒ†ãƒƒãƒ—2ã«æˆ»ã‚‹ã€
function onBackToStep2FromStep3() {
  document.getElementById("wizard-step3").style.display = "none";
  document.getElementById("wizard-step2").style.display = "block";
}

// ã€Œã“ã®ã‚·ãƒŠãƒªã‚ªã§å§‹ã‚ã‚‹ã€ => æ–°ã—ã„ã‚·ãƒŠãƒªã‚ªIDã‚’ç™ºè¡Œã—ã€scenario.html ã¸
async function onStartScenario() {
  try {
    // ã‚·ãƒŠãƒªã‚ªåã‚’ä½•ã«ã™ã‚‹ã‹ï¼Ÿ ã²ã¨ã¾ãšã‚¸ãƒ£ãƒ³ãƒ«ã‹ã€ã‚ã‚‹ã„ã¯ "æ–°ã‚·ãƒŠãƒªã‚ª"
    let title = wizardData.genre || "æ–°ã‚·ãƒŠãƒªã‚ª";

    // ã‚·ãƒŠãƒªã‚ªã‚’DBã«è¿½åŠ 
    const scenarioId = await createNewScenario(wizardData, title);

    // scenario.html?scenarioId=xxx ã«é£›ã¶
    window.location.href = `scenario.html?scenarioId=${scenarioId}`;
  } catch (err) {
    console.error("ã‚·ãƒŠãƒªã‚ªä½œæˆå¤±æ•—:", err);
    alert("ã‚·ãƒŠãƒªã‚ªã‚’é–‹å§‹ã§ãã¾ã›ã‚“ã§ã—ãŸ:\n" + err.message);
  }
}

/* ---- ã‚·ãƒŠãƒªã‚ªç”Ÿæˆ (GPTå‘¼ã³å‡ºã—) ---- */
async function generateScenarioSummaryAndClearCondition() {
  wizardData.scenarioSummary = "";
  wizardData.clearCondition = "";
  saveWizardDataToLocalStorage();

  const apiKey = localStorage.getItem("apiKey") || "";
  if (!apiKey) {
    alert("APIã‚­ãƒ¼ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚");
    return;
  }

  showLoadingModal(true);
  window.currentRequestController = new AbortController();
  const signal = window.currentRequestController.signal;

  try {
    const prompt = `
      ã‚ãªãŸã¯TRPGç”¨ã®ã‚·ãƒŠãƒªã‚ªä½œæˆã«é•·ã‘ãŸã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã§ã™ã€‚
      ã‚¸ãƒ£ãƒ³ãƒ«ã¯ã€Œ${wizardData.genre}ã€ã€ã‚·ãƒŠãƒªã‚ªã‚¿ã‚¤ãƒ—ã¯ã€Œç›®çš„é”æˆå‹ã€ã§ã™ã€‚
      ä»¥ä¸‹ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ï¼š
      1. ã‚·ãƒŠãƒªã‚ªã®æ¦‚è¦ï¼ˆçŸ­ã‚ï¼‰
      2. ã“ã®ã‚·ãƒŠãƒªã‚ªã®ã‚¯ãƒªã‚¢æ¡ä»¶ï¼ˆã€ã‚¯ãƒªã‚¢æ¡ä»¶ã€‘ã¨ã„ã†è¦‹å‡ºã—ã§æ›¸ã„ã¦ãã ã•ã„ï¼‰
         ãŸã ã—ã€ã€ã‚¯ãƒªã‚¢æ¡ä»¶ã€‘ã¯ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã«å…¬é–‹ã—ã¾ã›ã‚“ã€‚
    `;
    const messages = [
      { role: "system", content: "ã‚ãªãŸã¯å„ªç§€ãªTRPGã‚·ãƒŠãƒªã‚ªãƒ¡ãƒ¼ã‚«ãƒ¼ã§ã™ã€‚" },
      { role: "user", content: prompt }
    ];

    const response = await fetch("https://api.openai.com/v1/chat/completions", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "Authorization": `Bearer ${apiKey}`
      },
      body: JSON.stringify({
        model: "gpt-4",
        messages,
        temperature: 0.7
      }),
      signal
    });
    const data = await response.json();
    if (data.error) throw new Error(data.error.message);

    const text = data.choices[0].message.content;
    let clearConditionPart = "";
    let summaryPart = text;
    if (text.includes("ã€ã‚¯ãƒªã‚¢æ¡ä»¶ã€‘")) {
      const arr = text.split("ã€ã‚¯ãƒªã‚¢æ¡ä»¶ã€‘");
      summaryPart = arr[0].trim();
      clearConditionPart = arr[1] ? arr[1].trim() : "";
    }
    wizardData.scenarioSummary = summaryPart;
    wizardData.clearCondition = clearConditionPart;
  } catch (err) {
    if (err.name === "AbortError") {
      console.log("ç›®çš„é”æˆå‹ã‚·ãƒŠãƒªã‚ªç”Ÿæˆã‚­ãƒ£ãƒ³ã‚»ãƒ«");
    } else {
      console.error(err);
      alert("ç›®çš„é”æˆå‹ã‚·ãƒŠãƒªã‚ªç”Ÿæˆã«å¤±æ•—:\n" + err.message);
    }
  } finally {
    showLoadingModal(false);
    saveWizardDataToLocalStorage();
    updateSummaryUI();
  }
}

async function generateScenarioSummary() {
  wizardData.scenarioSummary = "";
  saveWizardDataToLocalStorage();

  const apiKey = localStorage.getItem("apiKey") || "";
  if (!apiKey) {
    alert("APIã‚­ãƒ¼ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚");
    return;
  }

  showLoadingModal(true);
  window.currentRequestController = new AbortController();
  const signal = window.currentRequestController.signal;

  try {
    const prompt = `
      ã‚ãªãŸã¯TRPGç”¨ã®ã‚·ãƒŠãƒªã‚ªä½œæˆã«é•·ã‘ãŸã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã§ã™ã€‚
      ã‚¸ãƒ£ãƒ³ãƒ«ã¯ã€Œ${wizardData.genre}ã€ã€ã‚·ãƒŠãƒªã‚ªã‚¿ã‚¤ãƒ—ã¯ã€Œæ¢ç´¢å‹ã€ã§ã™ã€‚
      ã‚¹ãƒˆãƒ¼ãƒªãƒ¼å†…ã§ã‚¨ãƒ¬ãƒ¡ãƒ³ãƒˆã‚’æ‰‹ã«å…¥ã‚Œã‚‹ã“ã¨ãŒã§ãã‚‹ã‚ˆã†ã«ã—ã¦ãã ã•ã„ã€‚
      æ¦‚è¦ã¯çŸ­ã‚ã§ã€ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒèˆˆå‘³ã‚’æŒã¡ãã†ãªè¨­å®šã‚’ç››ã‚Šè¾¼ã‚“ã§ãã ã•ã„ã€‚
    `;
    const messages = [
      { role: "system", content: "ã‚ãªãŸã¯å„ªç§€ãªTRPGã‚·ãƒŠãƒªã‚ªãƒ¡ãƒ¼ã‚«ãƒ¼ã§ã™ã€‚" },
      { role: "user", content: prompt }
    ];

    const response = await fetch("https://api.openai.com/v1/chat/completions", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "Authorization": `Bearer ${apiKey}`
      },
      body: JSON.stringify({
        model: "gpt-4",
        messages,
        temperature: 0.7
      }),
      signal
    });
    const data = await response.json();
    if (data.error) throw new Error(data.error.message);

    wizardData.scenarioSummary = data.choices[0].message.content;
  } catch (err) {
    if (err.name === "AbortError") {
      console.log("æ¢ç´¢å‹ã‚·ãƒŠãƒªã‚ªç”Ÿæˆã‚­ãƒ£ãƒ³ã‚»ãƒ«");
    } else {
      console.error(err);
      alert("æ¢ç´¢å‹ã‚·ãƒŠãƒªã‚ªç”Ÿæˆã«å¤±æ•—:\n" + err.message);
    }
  } finally {
    showLoadingModal(false);
    saveWizardDataToLocalStorage();
    updateSummaryUI();
  }
}

/* ---- è¡¨ç¤ºæ›´æ–° ---- */
function updateSummaryUI() {
  const summaryDiv = document.getElementById("scenario-summary");
  const scenario = wizardData.scenarioSummary || "ï¼ˆã‚·ãƒŠãƒªã‚ªæ¦‚è¦ãªã—ï¼‰";
  summaryDiv.textContent = scenario;
}

function updateSelectedGenreDisplay() {
  const displayEl = document.getElementById("selected-genre-display");
  if (!displayEl) return;
  if (wizardData.genre) {
    displayEl.textContent = wizardData.genre;
  } else {
    displayEl.textContent = "ï¼ˆæœªé¸æŠï¼‰";
  }
}

/* ---- localStorage ---- */
function loadWizardDataFromLocalStorage() {
  const dataStr = localStorage.getItem("wizardData");
  if (!dataStr) return;
  try {
    const obj = JSON.parse(dataStr);
    wizardData = obj;
  } catch (e) {
    console.warn("wizardData parseå¤±æ•—", e);
  }
}

function saveWizardDataToLocalStorage() {
  localStorage.setItem("wizardData", JSON.stringify(wizardData));
}

/* ---- ãƒ¢ãƒ¼ãƒ€ãƒ«æ“ä½œ ---- */
function showLoadingModal(show) {
  const modal = document.getElementById("loading-modal");
  if (!modal) return;
  modal.style.display = show ? "flex" : "none";
}

function onCancelFetch() {
  if (window.currentRequestController) {
    window.currentRequestController.abort();
  }
  showLoadingModal(false);
}

/** ãƒã‚¤ãƒ©ã‚¤ãƒˆ */
function highlightSelectedButton(container, targetBtn) {
  const allBtns = container.querySelectorAll(".candidate-button");
  allBtns.forEach(b => b.style.backgroundColor = "");
  targetBtn.style.backgroundColor = "#8BC34A";
}
--- 
scene.js 
/********************************
 * scene.js - ã‚·ãƒŠãƒªã‚ª/ã‚·ãƒ¼ãƒ³ç®¡ç†é–¢é€£ (è¤‡æ•°ã‚·ãƒŠãƒªã‚ªå¯¾å¿œ)
 ********************************/

window.apiKey = '';
window.sceneHistory = [];
window.currentScenarioId = null;
window.currentScenario = null;
window.currentRequestController = null;
window.cancelRequested = false;
window.editingImageEntry = null;

// ã‚·ãƒŠãƒªã‚ªã‚¿ã‚¤ãƒ—ã‚„ã‚¯ãƒªã‚¢æ¡ä»¶ï¼ˆç›®çš„é”æˆå‹/æ¢ç´¢å‹ã®åŒºåˆ¥ï¼‰
window.scenarioType = null;
window.clearCondition = null;

/** ãƒ¦ãƒ‹ãƒ¼ã‚¯IDç”Ÿæˆ */
function generateUniqueId() {
  return Date.now() + '_' + Math.random().toString(36).slice(2, 9);
}

/**
 * æŒ‡å®šã‚·ãƒŠãƒªã‚ªIDã‚’DBã‹ã‚‰ãƒ­ãƒ¼ãƒ‰ã—ã¦ sceneHistory ã‚’æ§‹ç¯‰
 */
async function loadScenarioData(scenarioId) {
  try {
    // ã‚·ãƒŠãƒªã‚ªæƒ…å ±
    const scenario = await getScenarioById(scenarioId);
    if (!scenario) {
      alert("æŒ‡å®šã•ã‚ŒãŸã‚·ãƒŠãƒªã‚ªIDãŒå­˜åœ¨ã—ã¾ã›ã‚“ã€‚");
      return;
    }
    window.currentScenario = scenario;

    // ã‚¦ã‚£ã‚¶ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰ã‚·ãƒŠãƒªã‚ªã‚¿ã‚¤ãƒ—ãªã©å¾©å…ƒ
    const wd = scenario.wizardData || {};
    window.scenarioType = wd.scenarioType;
    window.clearCondition = wd.clearCondition || "";

    // ã‚·ãƒ¼ãƒ³å±¥æ­´ã‚’å–å¾—
    const entries = await getSceneEntriesByScenarioId(scenarioId);
    window.sceneHistory = entries.map(e => ({
      entryId: e.entryId,
      type: e.type,
      sceneId: e.sceneId,
      content: e.content,
      dataUrl: e.dataUrl,
      prompt: e.prompt
    }));

    // ç›®çš„é”æˆå‹ãªã‚‰ãƒã‚¿ãƒãƒ¬ãƒœã‚¿ãƒ³è¡¨ç¤º
    if (window.scenarioType === "objective") {
      const sb = document.getElementById("spoiler-button");
      if (sb) sb.style.display = "inline-block";

      const spTxt = document.getElementById("clear-condition-text");
      if (spTxt) {
        spTxt.textContent = window.clearCondition || "ï¼ˆã‚¯ãƒªã‚¢æ¡ä»¶ãªã—ï¼‰";
      }
    }
    // æ¢ç´¢å‹ãªã‚‰ã€Œã‚«ãƒ¼ãƒ‰ã‚’å–å¾—ã™ã‚‹ã€ãƒœã‚¿ãƒ³è¡¨ç¤º
    else if (window.scenarioType === "exploration") {
      const gcb = document.getElementById("get-card-button");
      if (gcb) gcb.style.display = "inline-block";
    }

  } catch (err) {
    console.error("ã‚·ãƒŠãƒªã‚ªèª­ã¿è¾¼ã¿å¤±æ•—:", err);
    alert("ã‚·ãƒŠãƒªã‚ªèª­ã¿è¾¼ã¿å¤±æ•—:\n" + err.message);
  }
}

/**
 * ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼è¡Œå‹•ã‚’ã‚‚ã¨ã«æ¬¡ã®ã‚·ãƒ¼ãƒ³ã‚’ChatGPTã‹ã‚‰å–å¾—
 */
async function getNextScene() {
  if (!window.apiKey) {
    alert('APIã‚­ãƒ¼ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚');
    return;
  }
  const playerInput = (document.getElementById('player-input')?.value || "").trim();

  // æ—¢ã«ã‚·ãƒ¼ãƒ³ãŒã‚ã‚‹å ´åˆã¯è¡Œå‹•å¿…é ˆ
  const hasScene = window.sceneHistory.some(e => e.type === 'scene');
  if (hasScene && !playerInput) {
    alert('ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®è¡Œå‹•ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
    return;
  }

  window.cancelRequested = false;
  showLoadingModal(true);

  // ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç”¨ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ç©ã¿ä¸Šã’
  const messages = [
    { role: 'system', content: 'ã‚ãªãŸã¯TRPGã®ã‚²ãƒ¼ãƒ ãƒã‚¹ã‚¿ãƒ¼ã§ã™ã€‚HTMLã‚¿ã‚°OKã€‚' },
  ];

  // ã‚·ãƒŠãƒªã‚ªæ¦‚è¦ï¼ˆè¤‡æ•°ã‚·ãƒŠãƒªã‚ªå¯¾å¿œï¼‰
  if (window.currentScenario) {
    const wizardData = window.currentScenario.wizardData || {};
    const scenarioSummary = wizardData.scenarioSummary || "(æ¦‚è¦ãªã—)";
    messages.push({ role: 'user', content: `ã‚·ãƒŠãƒªã‚ªæ¦‚è¦:${scenarioSummary}` });
  }

  // éå»ã®ã‚·ãƒ¼ãƒ³å±¥æ­´ã‚’ChatGPTã«æ¸¡ã™
  window.sceneHistory.forEach(e => {
    if (e.type === 'scene') {
      messages.push({ role: 'assistant', content: e.content });
    } else if (e.type === 'action') {
      messages.push({ role: 'user', content: `ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®è¡Œå‹•:${e.content}` });
    }
  });

  // ä»Šå›ã®è¡Œå‹•
  if (playerInput) {
    messages.push({ role: 'user', content: `ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®è¡Œå‹•:${playerInput}` });
  }

  try {
    window.currentRequestController = new AbortController();
    const signal = window.currentRequestController.signal;

    const response = await fetch('https://api.openai.com/v1/chat/completions', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${window.apiKey}`
      },
      body: JSON.stringify({
        model: 'gpt-4',
        messages
      }),
      signal
    });
    if (window.cancelRequested) {
      showLoadingModal(false);
      return;
    }
    const data = await response.json();
    if (window.cancelRequested) {
      showLoadingModal(false);
      return;
    }
    if (data.error) {
      throw new Error(data.error.message);
    }

    const nextScene = data.choices[0].message.content;

    // 1) è¡Œå‹•ã‚’å±¥æ­´ã«è¿½åŠ 
    if (playerInput) {
      const actionEntry = {
        scenarioId: window.currentScenarioId || 0,
        type: 'action',
        content: playerInput,
        sceneId: null
      };
      const newActionId = await addSceneEntry(actionEntry);
      window.sceneHistory.push({
        entryId: newActionId,
        type: 'action',
        content: playerInput
      });
      document.getElementById('player-input').value = '';
    }

    // 2) æ¬¡ã®ã‚·ãƒ¼ãƒ³ã‚’å±¥æ­´ã«è¿½åŠ 
    const newSceneIdStr = generateUniqueId();
    const sceneEntry = {
      scenarioId: window.currentScenarioId || 0,
      type: 'scene',
      sceneId: newSceneIdStr,
      content: nextScene
    };
    const newSceneEntryId = await addSceneEntry(sceneEntry);
    window.sceneHistory.push({
      entryId: newSceneEntryId,
      type: 'scene',
      sceneId: newSceneIdStr,
      content: nextScene
    });

    // ç”»é¢æ›´æ–°
    updateSceneHistory();
    showLastScene();

    // ã‚·ãƒŠãƒªã‚ªæ›´æ–°æ—¥æ™‚
    if (window.currentScenario) {
      await updateScenario({
        ...window.currentScenario,
        updatedAt: new Date().toISOString()
      });
    }

  } catch (error) {
    if (error.name === 'AbortError') {
      console.warn('ã‚·ãƒ¼ãƒ³å–å¾—ã‚­ãƒ£ãƒ³ã‚»ãƒ«');
    } else {
      console.error('ã‚·ãƒ¼ãƒ³å–å¾—å¤±æ•—:', error);
      alert('ã‚·ãƒ¼ãƒ³å–å¾—ã«å¤±æ•—:\n' + error.message);
    }
  } finally {
    showLoadingModal(false);
  }
}

/**
 * ã‚·ãƒ¼ãƒ³å±¥æ­´ã‚’ç”»é¢ã«è¡¨ç¤ºï¼ˆæœ€æ–°1ä»¶ã‚’é™¤ã„ãŸã‚‚ã®ã‚’ã€Œå±¥æ­´ã€ã¨ã—ã¦è¡¨ç¤ºï¼‰
 */
function updateSceneHistory() {
  const historyContainer = document.getElementById('scene-history');
  if (!historyContainer) return;

  historyContainer.innerHTML = '';

  // æœ€æ–°ã‚·ãƒ¼ãƒ³ã‚’é™¤ã„ãŸå±¥æ­´ã‚’è¡¨ç¤º
  if (window.sceneHistory.length <= 1) {
    return;
  }
  const displayEntries = window.sceneHistory.slice(0, -1);

  displayEntries.forEach((entry) => {
    if (entry.type === 'scene') {
      // ã‚·ãƒ¼ãƒ³
      const tile = document.createElement('div');
      tile.className = 'history-tile';

      // å‰Šé™¤ãƒœã‚¿ãƒ³
      const deleteBtn = document.createElement('button');
      deleteBtn.textContent = 'å‰Šé™¤';
      deleteBtn.style.marginBottom = '5px';
      deleteBtn.addEventListener('click', async () => {
        if (!window.apiKey) return;

        const delSceneId = entry.sceneId;
        const toRemoveIds = [entry.entryId];
        // åŒã˜sceneIdã®ç”»åƒã‚‚å‰Šé™¤
        window.sceneHistory.forEach(e => {
          if (e.type === 'image' && e.sceneId === delSceneId) {
            toRemoveIds.push(e.entryId);
          }
        });
        // DBå‰Šé™¤
        for (const rid of toRemoveIds) {
          await deleteSceneEntry(rid);
        }
        // ãƒ¡ãƒ¢ãƒªå‰Šé™¤
        window.sceneHistory = window.sceneHistory.filter(e => !toRemoveIds.includes(e.entryId));

        updateSceneHistory();
        showLastScene();
      });
      tile.appendChild(deleteBtn);

      // ãƒ†ã‚­ã‚¹ãƒˆå¯å¤‰
      const sceneText = document.createElement('p');
      sceneText.className = 'scene-text';
      sceneText.setAttribute('contenteditable', window.apiKey ? 'true' : 'false');
      sceneText.innerHTML = DOMPurify.sanitize(entry.content);
      sceneText.addEventListener('blur', async () => {
        if (!window.apiKey) return;
        entry.content = sceneText.textContent.trim();
        const updated = {
          entryId: entry.entryId,
          scenarioId: window.currentScenarioId || 0,
          type: 'scene',
          sceneId: entry.sceneId,
          content: entry.content
        };
        await updateSceneEntry(updated);
      });
      tile.appendChild(sceneText);

      historyContainer.appendChild(tile);

    } else if (entry.type === 'action') {
      // è¡Œå‹•
      const tile = document.createElement('div');
      tile.className = 'history-tile';

      const deleteBtn = document.createElement('button');
      deleteBtn.textContent = 'å‰Šé™¤';
      deleteBtn.style.marginBottom = '5px';
      deleteBtn.addEventListener('click', async () => {
        if (!window.apiKey) return;

        await deleteSceneEntry(entry.entryId);
        window.sceneHistory = window.sceneHistory.filter(e => e.entryId !== entry.entryId);

        updateSceneHistory();
        showLastScene();
      });
      tile.appendChild(deleteBtn);

      const actionText = document.createElement('p');
      actionText.className = 'action-text';
      actionText.setAttribute('contenteditable', window.apiKey ? 'true' : 'false');
      actionText.innerHTML = DOMPurify.sanitize(entry.content);
      actionText.addEventListener('blur', async () => {
        if (!window.apiKey) return;
        entry.content = actionText.textContent.trim();
        const updated = {
          entryId: entry.entryId,
          scenarioId: window.currentScenarioId || 0,
          type: 'action',
          content: entry.content
        };
        await updateSceneEntry(updated);
      });
      tile.appendChild(actionText);

      historyContainer.appendChild(tile);

    } else if (entry.type === 'image') {
      // ç”»åƒ
      const tile = document.createElement('div');
      tile.className = 'history-tile';

      const img = document.createElement('img');
      img.src = entry.dataUrl;
      img.alt = 'ç”Ÿæˆç”»åƒ';
      img.style.maxWidth = '100%';
      tile.appendChild(img);

      // å†ç”Ÿæˆ
      const regenBtn = document.createElement('button');
      regenBtn.textContent = 'å†ç”Ÿæˆ';
      regenBtn.addEventListener('click', () => {
        if (!window.apiKey) return;
        const idx = window.sceneHistory.indexOf(entry);
        if (idx >= 0) {
          openImagePromptModal(entry.prompt, idx);
        }
      });
      tile.appendChild(regenBtn);

      // ç”»åƒå‰Šé™¤
      const imgDeleteBtn = document.createElement('button');
      imgDeleteBtn.textContent = 'ç”»åƒã ã‘å‰Šé™¤';
      imgDeleteBtn.addEventListener('click', async () => {
        if (!window.apiKey) return;
        await deleteSceneEntry(entry.entryId);
        window.sceneHistory = window.sceneHistory.filter(e => e.entryId !== entry.entryId);
        updateSceneHistory();
        showLastScene();
      });
      tile.appendChild(imgDeleteBtn);

      historyContainer.appendChild(tile);
    }
  });

  historyContainer.scrollTop = historyContainer.scrollHeight;
}

/**
 * æœ€æ–°ã‚·ãƒ¼ãƒ³(æœ«å°¾1ä»¶)ã‚’ãƒ¡ã‚¤ãƒ³è¡¨ç¤º
 */
function showLastScene() {
  const storyDiv = document.getElementById('story');
  const lastSceneImagesDiv = document.getElementById('last-scene-images');
  if (!storyDiv || !lastSceneImagesDiv) return;

  const nextSceneBtn = document.getElementById('next-scene');
  const playerInput = document.getElementById('player-input');
  const playerActionLabel = document.getElementById('player-action');

  const lastSceneEntry = [...window.sceneHistory].reverse().find(e => e.type === 'scene');

  if (lastSceneEntry) {
    // ãƒ†ã‚­ã‚¹ãƒˆéƒ¨åˆ†
    storyDiv.innerHTML = DOMPurify.sanitize(lastSceneEntry.content);
    lastSceneImagesDiv.innerHTML = '';

    // åŒã˜ sceneId ã®ç”»åƒã‚’ä¸‹ã«ä¸¦ã¹ã‚‹
    const images = window.sceneHistory.filter(e => e.type === 'image' && e.sceneId === lastSceneEntry.sceneId);
    images.forEach(imgEntry => {
      const container = document.createElement('div');
      container.style.marginBottom = '10px';

      const img = document.createElement('img');
      img.src = imgEntry.dataUrl;
      img.alt = 'ã‚·ãƒ¼ãƒ³ç”»åƒ';
      img.style.maxWidth = '100%';
      container.appendChild(img);

      // å†ç”Ÿæˆ
      const regenBtn = document.createElement('button');
      regenBtn.textContent = 'å†ç”Ÿæˆ';
      regenBtn.addEventListener('click', () => {
        if (!window.apiKey) return;
        const idx = window.sceneHistory.indexOf(imgEntry);
        if (idx >= 0) {
          openImagePromptModal(imgEntry.prompt, idx);
        }
      });
      container.appendChild(regenBtn);

      // ç”»åƒå‰Šé™¤
      const delBtn = document.createElement('button');
      delBtn.textContent = 'ç”»åƒå‰Šé™¤';
      delBtn.addEventListener('click', async () => {
        if (!window.apiKey) return;
        await deleteSceneEntry(imgEntry.entryId);
        window.sceneHistory = window.sceneHistory.filter(e => e.entryId !== imgEntry.entryId);
        showLastScene();
        updateSceneHistory();
      });
      container.appendChild(delBtn);

      lastSceneImagesDiv.appendChild(container);
    });

    // å…¥åŠ›é–¢é€£ã®è¡¨ç¤ºå¯å¦
    if (window.apiKey) {
      nextSceneBtn.style.display = 'inline-block';
      playerInput.style.display = 'inline-block';
      playerActionLabel.textContent = 'ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒã©ã‚“ãªè¡Œå‹•ã‚’å–ã‚‹ã‹ï¼Ÿ';
    } else {
      nextSceneBtn.style.display = 'none';
      playerInput.style.display = 'none';
      playerActionLabel.textContent = '';
    }
  } else {
    // ã‚·ãƒ¼ãƒ³ãŒç„¡ã„å ´åˆ => ã‚·ãƒŠãƒªã‚ªæ¦‚è¦ã‚’è¡¨ç¤º
    storyDiv.innerHTML = '';
    lastSceneImagesDiv.innerHTML = '';

    if (window.currentScenario && window.currentScenario.wizardData) {
      const summary = window.currentScenario.wizardData.scenarioSummary || "ï¼ˆã‚·ãƒŠãƒªã‚ªæ¦‚è¦ãªã—ï¼‰";
      storyDiv.innerHTML = `
        <div style="margin-bottom: 10px; font-weight: bold;">
          ${DOMPurify.sanitize(summary)}
        </div>
      `;
    }

    if (window.apiKey) {
      nextSceneBtn.style.display = 'inline-block';
      playerInput.style.display = 'block';
      playerActionLabel.textContent = 'æœ€åˆã®ã‚·ãƒ¼ãƒ³ã‚’ä½œã‚‹ãŸã‚ã«è¡Œå‹•ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚';
    } else {
      nextSceneBtn.style.display = 'none';
      playerInput.style.display = 'none';
      playerActionLabel.textContent = '';
    }
  }
}

/** ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º/éè¡¨ç¤º */
function showLoadingModal(show) {
  const modal = document.getElementById('loading-modal');
  if (!modal) return;
  modal.style.display = show ? 'flex' : 'none';
}

/** ãƒªã‚¯ã‚¨ã‚¹ãƒˆä¸­æ–­ */
function onCancelFetch() {
  window.cancelRequested = true;
  if (window.currentRequestController) {
    window.currentRequestController.abort();
  }
  showLoadingModal(false);
}
--- 
